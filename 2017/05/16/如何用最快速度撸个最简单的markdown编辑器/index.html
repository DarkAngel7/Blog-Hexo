<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>如何用最快速度撸个最简单的markdown编辑器 | Dark Angel</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> 
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/8.5/styles/github.min.css">
  <meta name="generator" content="Dark Angel">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="atom.xml">
  
  

  
</head>

<!--
<body class="post-template">
-->
<body class="home-template">
<div id="perspective" class="perspective effect-movedown">
  <div class="container">
    <!-- wrapper -->
    <div class="wrapper">

      <header class="site-head"  style="background: #24282b url(/img/img-bg.jpg) center; background-size: cover" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/avatar.jpg" alt="Blog Logo"/></a> 
            <h1 class="blog-title">Dark Angel</h1>
            <h2 class="blog-description"><button id="showMenu">Show Menu</button></h2>
        </div>
    </div>
</header>

      

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2017-05-16T07:29:38.000Z" itemprop="datePublished">
          2017-05-16
      </time>
    
    
    | 
    <a href='/tags/iOS技术分享/'>iOS技术分享</a>
    
    
</span>
    <h1 class="post-title">如何用最快速度撸个最简单的markdown编辑器</h1>
    <span id="busuanzi_value_page_pv"></span>次阅读
    <span class="ds-thread-count" data-thread-key="2017/05/16/如何用最快速度撸个最简单的markdown编辑器/"></span>
    <section class="post-content">
     	
              <div id="toc" class="toc-article">
                <strong class="toc-title">本文目录</strong>
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分析"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#方案"><span class="toc-text">方案</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实现"><span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#搭建UI"><span class="toc-text">搭建UI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#逻辑处理"><span class="toc-text">逻辑处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化"><span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加工具栏"><span class="toc-text">添加工具栏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#预览"><span class="toc-text">预览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#保存"><span class="toc-text">保存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#美化样式"><span class="toc-text">美化样式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol>
              </div>
            
	 <p><img src="http://ww2.sinaimg.cn/large/006tNc79ly1ffprjqeqhbj313k0iwgrw.jpg" alt="44281095-7821-49F2-9D89-82460D6263DB"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>相信不少小伙伴看过笔者前面发的《<strong>iOS中UIWebView与WKWebView、JavaScript与OC交互、Cookie管理看我就够</strong>》系列了吧，文章中笔者介绍过很多关于Native与JS交互的使用。今天呢，笔者来用最快速度撸个最简单的<code>Markdown</code>编辑器。</p>
<p>其实iOS原生Markdown编辑器的实现方式有很多，Github上面也有一些比较厉害的库，本着不重复造轮子的原则，<code>markdown</code>纯文本转<code>html</code>字符串这部分就不自己实现了，其他部分笔者用<code>JavaScriptCore</code>结合JS和OC（Swift其实也一样），来实现一个简单的<code>Markdown</code>编辑器。</p>
<p>这篇文章不是为了教大家如何开发<code>Markdown</code>编辑器，而是为广大iOS开发者打开一个新的思路，我们能使用的不只是iOS开源库，有了<code>JavaScriptCore</code>，即便脱离开<code>WebView</code>，我们也是可以使用<code>JavaScript</code>开源库的~😊</p>
<p>下面为小伙伴介绍下具体的实现细节，<a href="https://github.com/DarkAngel7/DAMarkdownEditor" target="_blank" rel="external">源码已上传Github</a>，希望小伙伴们喜欢的给个Star。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>如何在iOS上实现一个<code>markdown</code>编辑器呢？让我们来分析下。</p>
<ul>
<li>首先，既然是编辑器，那应该会用到<code>UITextView</code>控件。</li>
<li>其次，用户是在<code>UITextView</code>上输入的文本，那作为一个编辑器，应该会有预览功能，点击预览则可以看到html页面。</li>
<li>再次，点击预览实现的是<code>markdown</code>纯文本转<code>html</code>字符串，怎么实现呢？</li>
<li>最后，考虑给<code>UITextView</code>的<code>inputAccessoryView</code>添加一些用户常用的按钮，比如“#、link、img”等，便于用户操作。</li>
</ul>
<h1 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h1><p>上面提到的是笔者在做一个<code>markdown</code>编辑器时的思路，其实这个很重要，小伙伴们在遇到问题和处理问题时，也应该先整体思考，分析一下，然后得出实现方案，最后再去落实，养成一个好的习惯。</p>
<p>笔者的方案如下：</p>
<ul>
<li>页面结构：一个<code>UIViewController</code>上面放一个<code>UITextView</code>，顶部<code>NavigationBar</code>上面放个<strong>预览</strong>按钮和<strong>保存</strong>按钮。点击预览，查看编辑好的预览页；点击保存，保存当前文章到沙盒目录（真的业务需求的话可能是发送）。</li>
<li><code>UITextView</code>的<code>markdown</code>纯文本转<code>html</code>字符串，<a href="https://github.com/showdownjs/showdown" target="_blank" rel="external">通过成熟的<code>js</code>来实现</a>，至于交互，使用<code>JavaScriptCore</code>（不重复造轮子，就不自己写正则处理了）。</li>
<li>预览页直接用<code>WebView</code>加载<code>html</code>字符串即可。</li>
</ul>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="搭建UI"><a href="#搭建UI" class="headerlink" title="搭建UI"></a>搭建UI</h2><p>这个So easy，分分钟~如下图</p>
<p><img src="http://ww1.sinaimg.cn/large/006tNc79ly1ffpljo5k99j31kw0wlh03.jpg" alt="63DAF661-7D46-42D2-BDAC-935FDEA66532"></p>
<p>上面的图足够明确了吧~</p>
<p>编辑页中持有一个<code>JSContext</code>对象，同时持有一个<code>inputBar</code>，一个<code>TextView</code>（正文），一个<code>UITextField</code>（标题）。</p>
<p>预览页中是一个<code>UIWebView</code>（也可以是<code>WKWebView</code>）。</p>
<h2 id="逻辑处理"><a href="#逻辑处理" class="headerlink" title="逻辑处理"></a>逻辑处理</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p><code>EditViewController</code>中首先实现初始化方法。</p>
<pre><code class="objective-c">- (void)initialize
{
    self.textView.textContainerInset = UIEdgeInsetsMake(10, 5, 10, 5);
    //错误回调
    [self.jsContext setExceptionHandler:^(JSContext *context, JSValue *exception){
        NSLog(@&quot;%@&quot;, exception.toString);
    }];

    //markdown -&gt; html  js参考 https://github.com/showdownjs/showdown
    static NSString *js;
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        js = [NSString stringWithContentsOfFile:[[NSBundle mainBundle] pathForResource:@&quot;showdown&quot; ofType:@&quot;js&quot;] encoding:NSUTF8StringEncoding error:nil];
    });
    //加载js
    [self.jsContext evaluateScript:js];

    //注入function  markdown -&gt; html，使用时，可以通过 convert(&#39;xxx&#39;); 调用
    NSString *jsFunction = @&quot;\
                            function convert(md) { \
                                return (new showdown.Converter()).makeHtml(md);\
                            }&quot;;
    [self.jsContext evaluateScript:jsFunction];
}
</code></pre>
<p>上面的代码中，我们提前给<code>jsContext</code>注入<code>showdown.js</code>文件，然后可以使用<code>(new showdown.Converter()).makeHtml(md);</code>的方法来将<code>markdown</code>字符串转换为<code>html</code>字符串。那么我们也提前注入了一个方法<code>convert</code> <code>function</code>来供我们自己调用。</p>
<h3 id="添加工具栏"><a href="#添加工具栏" class="headerlink" title="添加工具栏"></a>添加工具栏</h3><p>有一些字符，比如”*、-“等都是很常用的，这里我们添加一个工具栏，便于用户快捷操作。我们在初始化方法<code>initialize</code>中添加如下的方法。</p>
<pre><code class="objective-c">self.textView.inputAccessoryView = self.inputBar;
</code></pre>
<p>当用户点击inputBar上的按钮时，触发事件：</p>
<pre><code class="objective-c">/**
 点击了toolBar上面的item

 @param item item
 */
- (IBAction)inputBarItemClicked:(UIBarButtonItem *)item
{
    NSString *title = item.title;
    //插入的文本内容
    NSString *insertText;
    //插入文本内容后，移动光标到指定位置
    NSRange selectedRange = self.textView.selectedRange;
    if ([title isEqualToString:@&quot;link&quot;]) {
        insertText = @&quot;[]()&quot;;
        selectedRange.location += 1;    //移动到 [ 后面
    } else if ([title isEqualToString:@&quot;img&quot;]) {
        insertText = @&quot;![]()&quot;;
        selectedRange.location += 4;    //移动到 ( 后面
    } else {
        insertText = title;
        selectedRange.location += title.length; //移动到插入文本的最后
    }
    //插入文本
    [self.textView insertText:insertText];
    //移动光标
    self.textView.selectedRange = selectedRange;
}
</code></pre>
<p>效果如下</p>
<p><img src="http://ww2.sinaimg.cn/large/006tNc79ly1ffpqjn9wngg30aa0iahdt.gif" alt="工具栏输入"></p>
<h3 id="预览"><a href="#预览" class="headerlink" title="预览"></a>预览</h3><p>此时用户可以愉悦地编辑内容，当用户编辑完成时，可以点击预览。预览的方法实现：</p>
<pre><code class="objective-c">/**
 预览

 @param sender item
 */
- (IBAction)preview:(id)sender
{
    //标题不能为空
    if (!self.titleTextField.text.length) {
        [self showMessage:@&quot;请先填写文章标题&quot;];
        return;
    }
    //跳转到预览页
    [self performSegueWithIdentifier:kShowPreviewSegueId sender:self];
}

#pragma mark - Setters and Getters

- (NSString *)htmlString
{
    //markdown -&gt; html
    JSValue *jsFunctionValue = self.jsContext[@&quot;convert&quot;];
    JSValue *htmlValue = [jsFunctionValue callWithArguments:@[self.textView.text]];
    return [NSString stringWithFormat:@&quot;\
            &lt;html&gt;\
                &lt;head&gt;\
                    &lt;title&gt;%@&lt;/title&gt;\
                &lt;/head&gt;\
                &lt;body&gt;\
                    %@\
                &lt;/body&gt;\
            &lt;/html&gt;\
            &quot;, self.titleTextField.text, htmlValue.toString];
}

#pragma mark - Navigation

- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender
{
    //跳转到预览页
    if ([segue.identifier isEqualToString:kShowPreviewSegueId]) {
        PreviewViewController *vc = segue.destinationViewController;
        vc.htmlString = [self htmlString];
        vc.title = self.titleTextField.text;
    }
}
</code></pre>
<p>点击预览，跳转到<code>PreviewViewController</code>页面，同时传递<code>htmlString</code>。这里如何获取<code>htmlString</code>呢？之前我们在<code>initialize</code>方法里，提前注入了名为<code>convert</code>的方法，现在我们来调用它</p>
<pre><code class="objective-c">JSValue *jsFunctionValue = self.jsContext[@&quot;convert&quot;];
JSValue *htmlValue = [jsFunctionValue callWithArguments:@[self.textView.text]];
</code></pre>
<p>那我们很容易获取到了<code>markdown</code>文本转换成<code>html</code>的字符串了，然后我们给这个字符串完善下，添加上<code>html</code>标签、<code>head</code>标签以及页面的<code>title</code>，然后传递给预览页，直接展示就OK了。</p>
<p>效果如下图</p>
<p><img src="http://ww2.sinaimg.cn/large/006tNc79ly1ffpqvmwpzfg30ac0ir49m.gif" alt="点击预览"></p>
<h3 id="保存"><a href="#保存" class="headerlink" title="保存"></a>保存</h3><p>其实保存，这里只是简单实现，保存到沙盒。实际业务需求，很可能是一个发送按钮，上传到服务器，或者是分享到其他的App。这里简单介绍下保存到沙盒。下面上代码</p>
<pre><code class="objective-c">/**
 保存到沙盒目录

 @param sender item
 */
- (IBAction)save:(id)sender
{
    //标题不能为空
    if (!self.titleTextField.text.length) {
        [self showMessage:@&quot;请先填写文章标题&quot;];
        return;
    }
    NSData *data = [self.textView.text dataUsingEncoding:NSUTF8StringEncoding];
    NSString *documentPath = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES).firstObject;
    NSString *filePath = [documentPath stringByAppendingPathComponent:[NSString stringWithFormat:@&quot;%@.md&quot;, self.titleTextField.text]];
    //写入文件
    [data writeToFile:filePath atomically:YES];
    NSLog(@&quot;md成功保存，地址%@&quot;, filePath);
    [self showMessage:@&quot;保存成功&quot;];
}
</code></pre>
<p>保存的时候，直接保存源码到本地，就好了，文件命名为<code>标题.md</code>。</p>
<p>当我点击保存时，保存到本地，同时输出</p>
<pre><code>DAMarkdownEditor[9717:192504] md成功保存，地址/Users/DarkAngel/Library/Developer/CoreSimulator/Devices/CF831783-E4A6-4EC2-AB99-E04304331C3A/data/Containers/Data/Application/A7837233-9EC3-4E4C-94CB-252329746176/Documents/A test title.md
</code></pre><p>我们用Safari，Cmd+Shift+G，打开上面的地址可以看到</p>
<p><img src="http://ww3.sinaimg.cn/large/006tNc79ly1ffpqsm8tfjj316s0o8jyj.jpg" alt="FC42EBA3-1996-4266-A7BC-9B2363F40E04"></p>
<p>打开这个文件，可以查看下，源码就是我们输入的内容。</p>
<p>其实到这里，我们已经完成一个简单的<code>Markdown</code>编辑器。但是小伙伴们可能会说，预览的<code>html</code>太丑了，中间的代码块都没有高亮。那如何解决呢？</p>
<h2 id="美化样式"><a href="#美化样式" class="headerlink" title="美化样式"></a>美化样式</h2><p>如果你拥有一点点前端知识，你会立刻想到，少了一个好看的<code>css</code>样式。我们可以通过给<code>html</code>添加<code>css</code>，来使页面看起来更好看。</p>
<p>下面我们在<code>- (NSString *)htmlString</code>方法中，给html添加css，这里我本地添加了一个<code>css</code>文件，直接读取并拼接到<code>head</code>标签中</p>
<pre><code class="objective-c">- (NSString *)htmlString
{
    //markdown -&gt; html
    JSValue *jsFunctionValue = self.jsContext[@&quot;convert&quot;];
    JSValue *htmlValue = [jsFunctionValue callWithArguments:@[self.textView.text]];
    //加载css样式
    static NSString *css;
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        css = [NSString stringWithContentsOfFile:[[NSBundle mainBundle] pathForResource:@&quot;markdown&quot; ofType:@&quot;css&quot;] encoding:NSUTF8StringEncoding error:nil];
    });
    return [NSString stringWithFormat:@&quot;\
            &lt;html&gt;\
                &lt;head&gt;\
                    &lt;title&gt;%@&lt;/title&gt;\
                    &lt;style&gt;%@&lt;/style&gt;\
                &lt;/head&gt;\
                &lt;body&gt;\
                    %@\
                &lt;/body&gt;\
            &lt;/html&gt;\
            &quot;, self.titleTextField.text, css, htmlValue.toString];
}
</code></pre>
<p>好啦，让我们再点击预览一下</p>
<p><img src="http://ww4.sinaimg.cn/large/006tNc79ly1ffpr28i2xlg30ac0ir7f7.gif" alt="添加css后，点击预览"></p>
<p>这下好看多了，如果小伙伴们想要自定义样式，只需要修改css文件就OK啦，当然Github上有很多好看的样式哦~可以找找看，也可以自己修改下css。</p>
<p>至此，我们的<code>Markdown</code>编辑器就完成了，<code>EditViewController</code>一共181行，<code>PreviewViewController</code>一共38行，加上一个简单的<code>Storyboard</code>，我们的编辑器非常清爽。后续，再可以优化下页面的UI、InputBar中多添加一些快捷按钮，优化下UE，我们就可以上传AppStore啦~</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>上面我们用很少的代码，很少的时间完成了一个简单的<code>Markdown</code>编辑器，又一次证明了<code>JavaScriptCore</code>的强大，同时也证明了前端如此火热的今天，Native开发依然是王道。<code>Github</code>前十的开源项目中，有<strong>六</strong>款是基于<code>JavaScript</code>语言的。可能有些小伙伴作为一个Native端开发，会很方，很多小伙伴开始学习前端，学习js。当然，学习新的东西本就无可厚非。但我相信，被动学习的不在少数。</p>
<p>那么，我们可不可以利用它，结合Native打造更好的App呢？答案是：一定可以。</p>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Dark Angel</h4>
    <p>iOS界的低调探索者</p>
</section>
    <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone"></a><a href="#" class="bds_tsina" data-cmd="tsina"></a><a href="#" class="bds_tqq" data-cmd="tqq"></a><a href="#" class="bds_renren" data-cmd="renren"></a><a href="#" class="bds_weixin" data-cmd="weixin"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdPic":"","bdStyle":"0","bdSize":"16"},"share":{},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <span class="icon-logo">•</span>
    
    <a class="older-posts" href="/2017/05/11/iOS中UIWebView与WKWebView、JavaScript与OC交互、Cookie管理看我就够（下）/">
        iOS中UIWebView与WKWebView、JavaScript与OC交互、Cookie管理看我就够（下） →
    </a>
    
</nav>

  <div id="comment" class="comments-area">
    
    	<!-- 多说评论框 start -->
　	<div class="ds-thread" data-thread-key="2017/05/16/如何用最快速度撸个最简单的markdown编辑器/" data-title="如何用最快速度撸个最简单的markdown编辑器" data-url="http://blog.darkangel7.com/2017/05/16/如何用最快速度撸个最简单的markdown编辑器/" data-auth-key="1"</div>	
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
		var duoshuoQuery = {short_name:"darkangel"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] 
		 	|| document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
	</script>
	<!-- 多说公共JS代码 end -->
    
</div>

</main>


      
<footer class="site-footer">
  
  <a class="subscribe icon-feed" href="/atom.xml"><span class="tooltip">Subscribe!</span></a>
  
  <div class="inner">
     <section class="copyright">原创文章，版权声明：署名-非商业性使用-相同方式共享 2.5</section>
     <section class="copyright"><a href="/">Dark Angel</a> &copy; 2016 &bull; All Rights Reserved.</section>
     <section class="poweredby">Powered By Hexo</section>
  </div>
</footer>

      <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/8.5/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>





  </div>
</div>

<nav  class="outer-nav top horizontal">

          <a class="icon-home"  href="/"><span>Home</span></a>

          <a class="icon-news"  href="/archives"><span>Archive</span></a>

          <a class="icon-wiki"  href="https://github.com/DarkAngel7"><span>Github</span></a>

          <a class="icon-Favorites"  href="/atom.xml"><span>Rss</span></a>

</nav>

</div>
</body>
</html>
