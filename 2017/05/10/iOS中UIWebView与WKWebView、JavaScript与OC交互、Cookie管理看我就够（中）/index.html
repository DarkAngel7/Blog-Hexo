<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸­ï¼‰ | Dark Angel</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> 
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/8.5/styles/github.min.css">
  <meta name="generator" content="Dark Angel">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="atom.xml">
  
  

  
</head>

<!--
<body class="post-template">
-->
<body class="home-template">
<div id="perspective" class="perspective effect-movedown">
  <div class="container">
    <!-- wrapper -->
    <div class="wrapper">

      <header class="site-head"  style="background: #24282b url(/img/img-bg.jpg) center; background-size: cover" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/avatar.jpg" alt="Blog Logo"/></a> 
            <h1 class="blog-title">Dark Angel</h1>
            <h2 class="blog-description"><button id="showMenu">Show Menu</button></h2>
        </div>
    </div>
</header>

      

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2017-05-10T02:10:09.000Z" itemprop="datePublished">
          2017-05-10
      </time>
    
    
    | 
    <a href='/tags/iOSæŠ€æœ¯åˆ†äº«/'>iOSæŠ€æœ¯åˆ†äº«</a>
    
    
</span>
    <h1 class="post-title">iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸­ï¼‰</h1>
    <span id="busuanzi_value_page_pv"></span>æ¬¡é˜…è¯»
    <span class="ds-thread-count" data-thread-key="2017/05/10/iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸­ï¼‰/"></span>
    <section class="post-content">
     	
              <div id="toc" class="toc-article">
                <strong class="toc-title">æœ¬æ–‡ç›®å½•</strong>
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#å‰è¨€"><span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WKWebView"><span class="toc-text">WKWebView</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ç®€ä»‹"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åŸºæœ¬ç”¨æ³•"><span class="toc-text">åŸºæœ¬ç”¨æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#åˆ›å»º"><span class="toc-text">åˆ›å»º</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#åŠ¨æ€æ³¨å…¥js"><span class="toc-text">åŠ¨æ€æ³¨å…¥js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#åŠ è½½"><span class="toc-text">åŠ è½½</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ä»£ç†"><span class="toc-text">ä»£ç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æ–°å±æ€§"><span class="toc-text">æ–°å±æ€§</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JavaScriptä¸Objective-Cçš„äº¤äº’"><span class="toc-text">JavaScriptä¸Objective-Cçš„äº¤äº’</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OC-gt-JS"><span class="toc-text">OC -> JS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JS-gt-OC"><span class="toc-text">JS -> OC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#URLæ‹¦æˆª"><span class="toc-text">URLæ‹¦æˆª</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#scriptMessageHandler"><span class="toc-text">scriptMessageHandler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å®é™…è¿ç”¨"><span class="toc-text">å®é™…è¿ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cookieç®¡ç†"><span class="toc-text">Cookieç®¡ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#è§£å†³é¦–æ¬¡åŠ è½½Cookieå¸¦ä¸ä¸Šé—®é¢˜"><span class="toc-text">è§£å†³é¦–æ¬¡åŠ è½½Cookieå¸¦ä¸ä¸Šé—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è§£å†³åç»­Ajaxè¯·æ±‚Cookieä¸¢å¤±é—®é¢˜"><span class="toc-text">è§£å†³åç»­Ajaxè¯·æ±‚Cookieä¸¢å¤±é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è§£å†³è·³è½¬æ–°é¡µé¢æ—¶Cookieå¸¦ä¸è¿‡å»é—®é¢˜"><span class="toc-text">è§£å†³è·³è½¬æ–°é¡µé¢æ—¶Cookieå¸¦ä¸è¿‡å»é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è§£å†³ä¸Šé¢3æ­¥éƒ½åšäº†Cookieä¾ç„¶ä¸¢å¤±"><span class="toc-text">è§£å†³ä¸Šé¢3æ­¥éƒ½åšäº†Cookieä¾ç„¶ä¸¢å¤±</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€§èƒ½å¯¹æ¯”"><span class="toc-text">æ€§èƒ½å¯¹æ¯”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å„ç§å‘"><span class="toc-text">å„ç§å‘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#js-alertæ–¹æ³•ä¸å¼¹çª—"><span class="toc-text">js alertæ–¹æ³•ä¸å¼¹çª—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç™½å±é—®é¢˜"><span class="toc-text">ç™½å±é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookieä¸¢å¤±"><span class="toc-text">Cookieä¸¢å¤±</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#evaluateJavaScript-completionHandler-å¼‚æ­¥"><span class="toc-text">evaluateJavaScript:completionHandler:å¼‚æ­¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è‡ªå®šä¹‰contentInsetåˆ·æ–°æ—¶é¡µé¢è·³åŠ¨çš„bug"><span class="toc-text">è‡ªå®šä¹‰contentInsetåˆ·æ–°æ—¶é¡µé¢è·³åŠ¨çš„bug</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åŠ è½½POSTè¯·æ±‚ä¸¢å¤±RequestBody"><span class="toc-text">åŠ è½½POSTè¯·æ±‚ä¸¢å¤±RequestBody</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSURLProtocolé—®é¢˜"><span class="toc-text">NSURLProtocolé—®é¢˜</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#æœªå®Œå¾…ç»­"><span class="toc-text">æœªå®Œå¾…ç»­</span></a></li></ol>
              </div>
            
	 <p><img src="http://ww4.sinaimg.cn/large/006tNc79ly1fff1sa06wrj30sg0iwwi9.jpg" alt=""></p>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å…³äº<code>UIWebView</code>çš„ä»‹ç»ï¼Œç›¸ä¿¡çœ‹è¿‡<a href="http://blog.darkangel7.com/2016/09/01/iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸Šï¼‰/">ä¸Šæ–‡</a>çš„å°ä¼™ä¼´ä»¬ï¼Œå·²ç»å¤§æ¦‚æ¸…æ¥šäº†å§ï¼Œå¦‚æœæœ‰é—®é¢˜ï¼Œæ¬¢è¿æé—®ã€‚</p>
<p>æœ¬æ–‡æ˜¯æœ¬ç³»åˆ—æ–‡ç« çš„ç¬¬äºŒç¯‡ï¼Œä¸»è¦ä¸ºå°ä¼™ä¼´ä»¬åˆ†äº«ä¸‹<code>WKWebView</code>ç›¸å…³çš„å†…å®¹ï¼š</p>
<ul>
<li><a href="http://blog.darkangel7.com/2016/09/01/iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸Šï¼‰/">iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸Šï¼‰</a></li>
<li>iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸­ï¼‰</li>
<li><a href="http://blog.darkangel7.com/2017/05/11/iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸‹ï¼‰/">iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸‹ï¼‰</a></li>
</ul>
<p>å…³äºæ–‡ä¸­æåˆ°çš„ä¸€äº›å†…å®¹ï¼Œè¿™é‡Œæˆ‘å‡†å¤‡äº†ä¸ª<a href="https://github.com/DarkAngel7/Demos-WebViewDemo" target="_blank" rel="external">Demo</a>ï¼Œæœ‰éœ€è¦çš„å°ä¼™ä¼´å¯ä»¥ä¸‹è½½ã€‚</p>
<h1 id="WKWebView"><a href="#WKWebView" class="headerlink" title="WKWebView"></a>WKWebView</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><code>WKWebView</code>æ˜¯AppleäºiOS 8.0æ¨å‡ºçš„<code>WebKit</code>ä¸­çš„æ ¸å¿ƒæ§ä»¶ï¼Œç”¨æ¥æ›¿ä»£<code>UIWebView</code>ã€‚<code>WKWebView</code>æ¯”<code>UIWebView</code>çš„ä¼˜åŠ¿åœ¨äºï¼š</p>
<ul>
<li><p>æ›´å¤šçš„æ”¯æŒHTML5çš„ç‰¹æ€§</p>
</li>
<li><p>é«˜è¾¾60fpsçš„æ»šåŠ¨åˆ·æ–°ç‡ä»¥åŠå†…ç½®æ‰‹åŠ¿</p>
</li>
<li>ä¸Safariç›¸åŒçš„JavaScriptå¼•æ“</li>
<li>å°†UIWebViewDelegateä¸UIWebViewæ‹†åˆ†æˆäº†14ç±»ä¸3ä¸ªåè®®ï¼ˆ<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/WebKit/ObjC_classic/index.html" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£è¯´æ˜</a>ï¼‰</li>
<li>å¯ä»¥è·å–åŠ è½½è¿›åº¦ï¼š<code>estimatedProgress</code>ï¼ˆUIWebViewéœ€è¦è°ƒç”¨ç§æœ‰Apiï¼‰</li>
</ul>
<p>ä½œè€…æœ¬äººåœ¨é¡¹ç›®ä¸­ä½¿ç”¨<code>WKWebView</code>ä¹Ÿ1å¹´å¤šäº†ï¼Œç¡®ç¡®å®å®æ„Ÿå—åˆ°äº†å®ƒçš„ä¼˜åŠ¿ï¼Œä½†æ˜¯åŒæ ·ä¹Ÿæ„Ÿå—åˆ°äº†å®ƒå¸¦æ¥çš„ä¸€äº›å‘ã€‚ä¸‹é¢æ¥å…·ä½“çš„ä»‹ç»ä¸‹<code>WKWebView</code>ã€‚å…¶å®Appleå¼€æºäº†<a href="https://opensource.apple.com/source/WebKit2/" target="_blank" rel="external">WebKit</a>ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥ç ”ç©¶ä¸‹å®ƒçš„å®ç°ã€‚</p>
<h2 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h2><h4 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h4><p><code>WKWebView</code>çš„åˆ›å»ºæ–¹æ³•æœ‰è¿™ä¸¤ç§</p>
<pre><code class="objective-c">/*-initWithFrame: to initialize an instance with the default configuration. å¦‚æœä½¿ç”¨initWithFrameæ–¹æ³•å°†ä½¿ç”¨é»˜è®¤çš„configuration
The initializer copies the specified configuration, so mutating the configuration after invoking the initializer has no effect on the web view. æˆ‘ä»¬éœ€è¦å…ˆè®¾ç½®configurationï¼Œå†è°ƒç”¨initï¼Œåœ¨initä¹‹åä¿®æ”¹configurationåˆ™æ— æ•ˆ
*/
- (instancetype)initWithFrame:(CGRect)frame configuration:(WKWebViewConfiguration *)configuration NS_DESIGNATED_INITIALIZER;
- (nullable instancetype)initWithCoder:(NSCoder *)coder NS_DESIGNATED_INITIALIZER;
</code></pre>
<p>ä»”ç»†çœ‹ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œæ¯”<code>UIWebView</code>å¤šäº†ä¸ª<code>configuration</code>ï¼Œè¿™ä¸ªé…ç½®å¯ä»¥è®¾ç½®å¾ˆå¤šä¸œè¥¿ã€‚å…·ä½“æŸ¥çœ‹<code>WKWebViewConfiguration.h</code>ï¼Œå¯ä»¥é…ç½®jsæ˜¯å¦æ”¯æŒï¼Œç”»ä¸­ç”»æ˜¯å¦å¼€å¯ç­‰ï¼Œè¿™é‡Œä¸»è¦è®²ä¸¤ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„å±æ€§ã€‚</p>
<p>ç¬¬ä¸€ä¸ªå±æ€§æ˜¯<code>websiteDataStore</code>ã€‚</p>
<pre><code class="objective-c">/*! @abstract The website data store to be used by the web view.
 */
@property (nonatomic, strong) WKWebsiteDataStore *websiteDataStore API_AVAILABLE(macosx(10.11), ios(9.0));
</code></pre>
<p>ä¸šç•Œæ™®éè®¤ä¸º <code>WKWebView</code> æ‹¥æœ‰è‡ªå·±çš„ç§æœ‰å­˜å‚¨ï¼Œå®ƒçš„ä¸€äº›ç¼“å­˜ç­‰æ•°æ®éƒ½å­˜åœ¨<code>websiteDataStore</code>ä¸­ï¼Œå…·ä½“å¢åˆ æ”¹æŸ¥å°±å¯ä»¥é€šè¿‡<code>WKWebsiteDataStore.h</code>ä¸­æä¾›çš„æ–¹æ³•ï¼Œè¿™é‡Œä¸å¤šè¯´ï¼Œä¸€èˆ¬ç”¨çš„æ—¶å€™æ¯”è¾ƒå°‘ï¼ŒçœŸçš„è¦æ¸…é™¤ç¼“å­˜ï¼Œç®€å•ç²—æš´çš„æ–¹æ³•æ˜¯åˆ é™¤æ²™ç›’ç›®å½•ä¸­çš„Cacheæ–‡ä»¶å¤¹ã€‚</p>
<p>ç¬¬äºŒä¸ªå±æ€§æ˜¯<code>userContentController</code>ã€‚</p>
<pre><code class="objective-c">/*! @abstract The user content controller to associate with the web view.
*/
@property (nonatomic, strong) WKUserContentController *userContentController;
</code></pre>
<p>è¿™ä¸ªå±æ€§å¾ˆé‡è¦ï¼Œåé¢è®²çš„js-&gt;ocçš„äº¤äº’ï¼Œä»¥åŠæ³¨å…¥jsä»£ç éƒ½ä¼šç”¨åˆ°å®ƒã€‚æŸ¥çœ‹<code>WKUserContentController</code>çš„å¤´æ–‡ä»¶ï¼Œä½ ä¼šå‘ç°å®ƒæœ‰å¦‚ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š</p>
<pre><code class="objective-c">@interface WKUserContentController : NSObject &lt;NSCoding&gt;
//è¯»å–æ·»åŠ è¿‡çš„è„šæœ¬
@property (nonatomic, readonly, copy) NSArray&lt;WKUserScript *&gt; *userScripts;
//æ·»åŠ è„šæœ¬
- (void)addUserScript:(WKUserScript *)userScript;
//åˆ é™¤æ‰€æœ‰æ·»åŠ çš„è„šæœ¬
- (void)removeAllUserScripts;
//é€šè¿‡window.webkit.messageHandlers.&lt;name&gt;.postMessage(&lt;messageBody&gt;) æ¥å®ç°js-&gt;ocä¼ é€’æ¶ˆæ¯ï¼Œå¹¶æ·»åŠ handler
- (void)addScriptMessageHandler:(id &lt;WKScriptMessageHandler&gt;)scriptMessageHandler name:(NSString *)name;
//åˆ é™¤handler
- (void)removeScriptMessageHandlerForName:(NSString *)name;
@end
</code></pre>
<p>é‚£ä¹ˆæ•´ä½“æˆ‘åˆ›å»ºä¸€ä¸ª<code>WKWebView</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="objective-c">WKWebViewConfiguration *configuration = [[WKWebViewConfiguration alloc] init];
WKUserContentController *controller = [[WKUserContentController alloc] init];
configuration.userContentController = controller;
self.webView = [[WKWebView alloc] initWithFrame:self.view.bounds configuration:configuration];
self.webView.allowsBackForwardNavigationGestures = YES;    //å…è®¸å³æ»‘è¿”å›ä¸Šä¸ªé“¾æ¥ï¼Œå·¦æ»‘å‰è¿›
self.webView.allowsLinkPreview = YES; //å…è®¸é“¾æ¥3D Touch
self.webView.customUserAgent = @&quot;WebViewDemo/1.0.0&quot;; //è‡ªå®šä¹‰UAï¼ŒUIWebViewå°±æ²¡æœ‰æ­¤åŠŸèƒ½ï¼Œåé¢ä¼šè®²åˆ°é€šè¿‡å…¶ä»–æ–¹å¼å®ç°
self.webView.UIDelegate = self;
self.webView.navigationDelegate = self;
[self.view addSubview:self.webView];
</code></pre>
<h4 id="åŠ¨æ€æ³¨å…¥js"><a href="#åŠ¨æ€æ³¨å…¥js" class="headerlink" title="åŠ¨æ€æ³¨å…¥js"></a>åŠ¨æ€æ³¨å…¥js</h4><p>é€šè¿‡ç»™<code>userContentController</code>æ·»åŠ <code>WKUserScript</code>ï¼Œå¯ä»¥å®ç°åŠ¨æ€æ³¨å…¥jsã€‚æ¯”å¦‚æˆ‘å…ˆæ³¨å…¥ä¸€ä¸ªè„šæœ¬ï¼Œç»™æ¯ä¸ªé¡µé¢æ·»åŠ ä¸€ä¸ªCookie</p>
<pre><code class="objective-c">//æ³¨å…¥ä¸€ä¸ªCookie
WKUserScript *newCookieScript = [[WKUserScript alloc] initWithSource:@&quot;document.cookie = &#39;DarkAngelCookie=DarkAngel;&#39;&quot; injectionTime:WKUserScriptInjectionTimeAtDocumentStart forMainFrameOnly:NO];
[controller addUserScript:newCookieScript];
</code></pre>
<p>ç„¶åå†æ³¨å…¥ä¸€ä¸ªè„šæœ¬ï¼Œæ¯å½“é¡µé¢åŠ è½½ï¼Œå°±ä¼šalertå½“å‰é¡µé¢cookieï¼Œåœ¨OCä¸­çš„å®ç°</p>
<pre><code class="objective-c">//åˆ›å»ºè„šæœ¬
WKUserScript *cookieScript = [[WKUserScript alloc] initWithSource:@&quot;alert(document.cookie);&quot; injectionTime:WKUserScriptInjectionTimeAtDocumentEnd forMainFrameOnly:NO];
//æ·»åŠ è„šæœ¬
[controller addUserScript:script];
</code></pre>
<p>è¿™æ ·æ¯å½“é¡µé¢å‡ºç°çš„æ—¶å€™ï¼Œä¼šaletå¼¹å‡ºå½“å‰é¡µé¢æ‰€æœ‰çš„cookieå­—ç¬¦ä¸²ã€‚<img src="http://ww1.sinaimg.cn/large/006tNc79ly1ffgc3n3b8fj30ku12aq38.jpg" width="200px;"></p>
<p>æ³¨å…¥çš„js sourceå¯ä»¥æ˜¯ä»»ä½•jså­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥jsæ–‡ä»¶ã€‚æ¯”å¦‚ä½ æœ‰å¾ˆå¤šæä¾›ç»™h5ä½¿ç”¨çš„jsæ–¹æ³•ï¼Œé‚£ä¹ˆä½ æœ¬åœ°å¯èƒ½å°±ä¼šæœ‰ä¸€ä¸ª<code>native_functions.js</code>ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„æ–¹å¼æ·»åŠ </p>
<pre><code class="objective-c">//é˜²æ­¢é¢‘ç¹IOæ“ä½œï¼Œé€ æˆæ€§èƒ½å½±å“
static NSString *jsSource;
static dispatch_once_t onceToken;
  dispatch_once(&amp;onceToken, ^{
      jsSource = [NSString stringWithContentsOfFile:[[NSBundle mainBundle] pathForResource:@&quot;native_functions&quot; ofType:@&quot;js&quot;] encoding:NSUTF8StringEncoding error:nil];
});
//æ·»åŠ è‡ªå®šä¹‰çš„è„šæœ¬
WKUserScript *js = [[WKUserScript alloc] initWithSource:jsSource injectionTime:WKUserScriptInjectionTimeAtDocumentEnd forMainFrameOnly:NO];
[self.configuration.userContentController addUserScript:js];
</code></pre>
<h4 id="åŠ è½½"><a href="#åŠ è½½" class="headerlink" title="åŠ è½½"></a>åŠ è½½</h4><p>åŠ è½½ä¸€ä¸ªè¯·æ±‚æˆ–è€…é¡µé¢ä¹Ÿå¾ˆç®€å•</p>
<pre><code class="objective-c">- (nullable WKNavigation *)loadRequest:(NSURLRequest *)request;
- (nullable WKNavigation *)loadFileURL:(NSURL *)URL allowingReadAccessToURL:(NSURL *)readAccessURL API_AVAILABLE(macosx(10.11), ios(9.0));
- (nullable WKNavigation *)loadHTMLString:(NSString *)string baseURL:(nullable NSURL *)baseURL;
- (nullable WKNavigation *)loadData:(NSData *)data MIMEType:(NSString *)MIMEType characterEncodingName:(NSString *)characterEncodingName baseURL:(NSURL *)baseURL API_AVAILABLE(macosx(10.11), ios(9.0));
</code></pre>
<p>åŸºæœ¬ä¸<code>UIWebView</code>çš„å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯éœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒåŠ è½½æœ¬åœ°çš„ä¸€ä¸ªhtmléœ€è¦ä½¿ç”¨<code>loadRequest:</code>æ–¹æ³•ï¼Œä½¿ç”¨<code>loadHTMLString:baseURL:</code>æ–¹æ³•ä¼šæœ‰é—®é¢˜ã€‚</p>
<pre><code class="objective-c">[self.webView loadRequest:[NSURLRequest requestWithURL:[NSURL fileURLWithPath:[[NSBundle mainBundle] pathForResource:@&quot;test&quot; ofType:@&quot;html&quot;]]]];
</code></pre>
<h4 id="ä»£ç†"><a href="#ä»£ç†" class="headerlink" title="ä»£ç†"></a>ä»£ç†</h4><p>åœ¨<code>WKWebView</code>çš„å¤´æ–‡ä»¶ï¼Œä½ ä¼šå‘ç°</p>
<pre><code class="objective-c">@protocol WKNavigationDelegate;    //ç±»ä¼¼äºUIWebViewçš„åŠ è½½æˆåŠŸã€å¤±è´¥ã€æ˜¯å¦å…è®¸è·³è½¬ç­‰
@protocol WKUIDelegate;    //ä¸»è¦æ˜¯ä¸€äº›alertã€æ‰“å¼€æ–°çª—å£ä¹‹ç±»çš„
</code></pre>
<p>æœ‰ä¸¤ä¸ªåè®®ï¼Œå®ƒå°†<code>UIWebView</code>çš„ä»£ç†åè®®æ‹†æˆäº†ä¸€ä¸ªè·³è½¬çš„åè®®å’Œä¸€ä¸ªå…³äºUIçš„åè®®ã€‚è™½è¯´è¿™ä¸¤ä¸ªåè®®ä¸­çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯Optionalï¼Œä½†æ˜¯å…³äº<code>WKUIDelegate</code>åè®®æ˜¯æœ‰å‘çš„ï¼Œåé¢çš„<strong>å„ç§å‘</strong>ä¸­ä¼šæåˆ°ã€‚ç®€å•è¯´ä¸‹<code>WKNavigationDelegate</code>ä¸­æ¯”è¾ƒå¸¸ç”¨çš„æ–¹æ³•</p>
<pre><code class="objective-c">//ä¸‹é¢è¿™2ä¸ªæ–¹æ³•å…±åŒå¯¹åº”äº†UIWebViewçš„ - (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType;
//å…ˆï¼šé’ˆå¯¹ä¸€æ¬¡actionæ¥å†³å®šæ˜¯å¦å…è®¸è·³è½¬ï¼Œactionä¸­å¯ä»¥è·å–requestï¼Œå…è®¸ä¸å¦éƒ½éœ€è¦è°ƒç”¨decisionHandlerï¼Œæ¯”å¦‚decisionHandler(WKNavigationActionPolicyCancel);
- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandlerï¼›
//åï¼šæ ¹æ®responseæ¥å†³å®šï¼Œæ˜¯å¦å…è®¸è·³è½¬ï¼Œå…è®¸ä¸å¦éƒ½éœ€è¦è°ƒç”¨decisionHandlerï¼Œå¦‚decisionHandler(WKNavigationResponsePolicyAllow);
- (void)webView:(WKWebView *)webView decidePolicyForNavigationResponse:(WKNavigationResponse *)navigationResponse decisionHandler:(void (^)(WKNavigationResponsePolicy))decisionHandler;

//å¼€å§‹åŠ è½½ï¼Œå¯¹åº”UIWebViewçš„- (void)webViewDidStartLoad:(UIWebView *)webView;
- (void)webView:(WKWebView *)webView didStartProvisionalNavigation:(null_unspecified WKNavigation *)navigation;

//åŠ è½½æˆåŠŸï¼Œå¯¹åº”UIWebViewçš„- (void)webViewDidFinishLoad:(UIWebView *)webView;
- (void)webView:(WKWebView *)webView didFinishNavigation:(null_unspecified WKNavigation *)navigation;

//åŠ è½½å¤±è´¥ï¼Œå¯¹åº”UIWebViewçš„- (void)webView:(UIWebView *)webView didFailLoadWithError:(NSError *)error;
- (void)webView:(WKWebView *)webView didFailNavigation:(null_unspecified WKNavigation *)navigation withError:(NSError *)error;
</code></pre>
<p><code>WKUIDelegate</code>è¿™é‡Œå…ˆä¸æäº†ï¼Œå°ä¼™ä¼´ä»¬å¯ä»¥å‚è€ƒæˆ‘<a href="https://github.com/DarkAngel7/Demos-WebViewDemo" target="_blank" rel="external">Demo</a>ä¸­çš„å®ç°ã€‚</p>
<h4 id="æ–°å±æ€§"><a href="#æ–°å±æ€§" class="headerlink" title="æ–°å±æ€§"></a>æ–°å±æ€§</h4><p><code>WKWebView.h</code>å®šä¹‰äº†å¦‚ä¸‹å‡ ä¸ªå¸¸ç”¨çš„<code>readonly</code>å±æ€§ï¼š</p>
<pre><code class="objective-c">@property (nullable, nonatomic, readonly, copy) NSString *title;    //é¡µé¢çš„titleï¼Œç»ˆäºå¯ä»¥ç›´æ¥è·å–äº†
@property (nullable, nonatomic, readonly, copy) NSURL *URL;        //å½“å‰webViewçš„URL
@property (nonatomic, readonly, getter=isLoading) BOOL loading;    //æ˜¯å¦æ­£åœ¨åŠ è½½
@property (nonatomic, readonly) double estimatedProgress;    //åŠ è½½çš„è¿›åº¦
@property (nonatomic, readonly) BOOL canGoBack;    //æ˜¯å¦å¯ä»¥åé€€ï¼Œè·ŸUIWebViewç›¸åŒ
@property (nonatomic, readonly) BOOL canGoForward;    //æ˜¯å¦å¯ä»¥å‰è¿›ï¼Œè·ŸUIWebViewç›¸åŒ
</code></pre>
<p>è¿™äº›å±æ€§éƒ½å¾ˆæœ‰ç”¨ï¼Œè€Œä¸”æ”¯æŒKVOï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡KVOè§‚å¯Ÿè¿™äº›å€¼çš„å˜åŒ–ï¼Œä»¥ä¾¿äºæˆ‘ä»¬åšå‡ºæœ€å‹å¥½çš„äº¤äº’ã€‚</p>
<h2 id="JavaScriptä¸Objective-Cçš„äº¤äº’"><a href="#JavaScriptä¸Objective-Cçš„äº¤äº’" class="headerlink" title="JavaScriptä¸Objective-Cçš„äº¤äº’"></a>JavaScriptä¸Objective-Cçš„äº¤äº’</h2><p>ä»‹ç»å®Œ<code>WKWebView</code>çš„åŸºæœ¬ç”¨æ³•ï¼Œè®©æˆ‘ä»¬æ¥ç ”ç©¶ä¸‹åŸºäºå®ƒçš„jsä¸ocçš„äº¤äº’ã€‚</p>
<h3 id="OC-gt-JS"><a href="#OC-gt-JS" class="headerlink" title="OC -&gt; JS"></a>OC -&gt; JS</h3><p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œ<code>WKWebView</code>æä¾›äº†ä¸€ä¸ªç±»ä¼¼<code>JavaScriptCore</code>çš„æ–¹æ³•</p>
<pre><code class="objective-c">//æ‰§è¡Œä¸€æ®µjsï¼Œå¹¶å°†ç»“æœè¿”å›ï¼Œå¦‚æœå‡ºé”™ï¼Œerroråˆ™ä¸ä¸ºç©º
- (void)evaluateJavaScript:(NSString *)javaScriptString completionHandler:(void (^ _Nullable)(_Nullable id result, NSError * _Nullable error))completionHandler;
</code></pre>
<p>è¯¥æ–¹æ³•å¾ˆå¥½çš„è§£å†³äº†ä¹‹å‰æ–‡ç« ä¸­æåˆ°çš„<code>UIWebView</code>ä½¿ç”¨<code>stringByEvaluatingJavaScriptFromString:</code>æ–¹æ³•çš„ä¸¤ä¸ªç¼ºç‚¹ï¼ˆ1. è¿”å›å€¼åªèƒ½æ˜¯NSStringã€‚2. æŠ¥é”™æ— æ³•æ•è·ï¼‰ã€‚æ¯”å¦‚æˆ‘æƒ³è·å–é¡µé¢ä¸­çš„<code>title</code>ï¼Œé™¤äº†ç›´æ¥<code>self.webView.title</code>å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼š</p>
<pre><code class="objective-c">[self.webView evaluateJavaScript:@&quot;document.title&quot; completionHandler:^(id _Nullable title, NSError * _Nullable error) {
        NSLog(@&quot;è°ƒç”¨evaluateJavaScriptå¼‚æ­¥è·å–titleï¼š%@&quot;, title);
}];
</code></pre>
<h3 id="JS-gt-OC"><a href="#JS-gt-OC" class="headerlink" title="JS -&gt; OC"></a>JS -&gt; OC</h3><h4 id="URLæ‹¦æˆª"><a href="#URLæ‹¦æˆª" class="headerlink" title="URLæ‹¦æˆª"></a>URLæ‹¦æˆª</h4><p>æ­¤æ–¹æ³•ä¸ä¸Šç¯‡æ–‡ç« ä¸­<code>UIWebView</code>ä»‹ç»åˆ°çš„URLæ‹¦æˆªæ–¹æ³•ä¸€è‡´ï¼Œéƒ½æ˜¯é€šè¿‡è‡ªå®šä¹‰Schemeï¼Œåœ¨é“¾æ¥æ¿€æ´»æ—¶ï¼Œæ‹¦æˆªè¯¥URLï¼Œæ‹¿åˆ°å‚æ•°ï¼Œè°ƒç”¨OCæ–¹æ³•ï¼Œç¼ºç‚¹ä¾ç„¶æ˜æ˜¾ã€‚<code>WKWebView</code>å®ç°èµ·æ¥å¦‚ä¸‹ï¼š</p>
<p>æ¯”å¦‚æˆ‘çš„é“¾æ¥ä¾ç„¶æ˜¯</p>
<pre><code class="html">&lt;a href=&quot;darkangel://smsLogin?username=12323123&amp;code=892845&quot;&gt;çŸ­ä¿¡éªŒè¯ç™»å½•&lt;/a&gt;
</code></pre>
<p>å½“ç”¨æˆ·ç‚¹å‡»è¿™ä¸ªaæ ‡ç­¾æ—¶ï¼Œä¼šè¢«æ‹¦æˆª</p>
<pre><code class="objective-c">- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler {
    //å¯ä»¥é€šè¿‡navigationAction.navigationTypeè·å–è·³è½¬ç±»å‹ï¼Œå¦‚æ–°é“¾æ¥ã€åé€€ç­‰
    NSURL *URL = navigationAction.request.URL;
    //åˆ¤æ–­URLæ˜¯å¦ç¬¦åˆè‡ªå®šä¹‰çš„URL Scheme
    if ([URL.scheme isEqualToString:@&quot;darkangel&quot;]) {
        //æ ¹æ®ä¸åŒçš„ä¸šåŠ¡ï¼Œæ¥æ‰§è¡Œå¯¹åº”çš„æ“ä½œï¼Œä¸”è·å–å‚æ•°
        if ([URL.host isEqualToString:@&quot;smsLogin&quot;]) {
            NSString *param = URL.query;
            NSLog(@&quot;çŸ­ä¿¡éªŒè¯ç ç™»å½•, å‚æ•°ä¸º%@&quot;, param);
            decisionHandler(WKNavigationActionPolicyCancel);
            return;
        }
    }
    decisionHandler(WKNavigationActionPolicyAllow);
    NSLog(@&quot;%@&quot;, NSStringFromSelector(_cmd));
}
</code></pre>
<p>æ•´ä½“å®ç°æ˜¯ä¸<code>UIWebView</code>ååˆ†ç›¸ä¼¼çš„ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚</p>
<p>è¿™é‡Œå†æ¬¡æä¸€ä¸‹<a href="https://github.com/marcuswestin/WebViewJavascriptBridge" target="_blank" rel="external">WebViewJavascriptBridge</a>ï¼Œå®ƒåœ¨æœ€è¿‘çš„æ–°ç‰ˆæœ¬ä¸­æ”¯æŒäº†<code>WKWebView</code>ã€‚ä½¿ç”¨çš„æ–¹æ¡ˆåŒæ ·æ˜¯<strong>æ‹¦æˆªURL</strong>ï¼Œå…·ä½“åŸç†åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ç®€å•æè¿°è¿‡ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ä¸‹é¢è¯´ä¸‹Appleçš„æ–°æ–¹æ³•ã€‚</p>
<h4 id="scriptMessageHandler"><a href="#scriptMessageHandler" class="headerlink" title="scriptMessageHandler"></a>scriptMessageHandler</h4><p>è¿™æ˜¯Appleåœ¨<code>WebKit</code>é‡Œæ–°å¢åŠ çš„æ–¹æ³•ï¼Œä½äº<code>WKUserContentController.h</code>ã€‚</p>
<pre><code class="objective-c">/*! @abstract Adds a script message handler.
 @param scriptMessageHandler The message handler to add.
 @param name The name of the message handler.
 @discussion Adding a scriptMessageHandler adds a function
 window.webkit.messageHandlers.&lt;name&gt;.postMessage(&lt;messageBody&gt;) for all
 frames.
 */
- (void)addScriptMessageHandler:(id &lt;WKScriptMessageHandler&gt;)scriptMessageHandler name:(NSString *)name;

/*! @abstract Removes a script message handler.
 @param name The name of the message handler to remove.
 */
- (void)removeScriptMessageHandlerForName:(NSString *)name;
</code></pre>
<p>å…¶å®Appleçš„æ³¨é‡Šå·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œåœ¨OCä¸­æ·»åŠ ä¸€ä¸ªscriptMessageHandlerï¼Œåˆ™ä¼šåœ¨<code>all frames</code>ä¸­æ·»åŠ ä¸€ä¸ªjsçš„functionï¼š <code>window.webkit.messageHandlers.&lt;name&gt;.postMessage(&lt;messageBody&gt;)</code> ã€‚é‚£ä¹ˆå½“æˆ‘åœ¨OCä¸­é€šè¿‡å¦‚ä¸‹çš„æ–¹æ³•æ·»åŠ äº†ä¸€ä¸ªhandlerï¼Œå¦‚</p>
<pre><code class="objective-c">[controller addScriptMessageHandler:self name:@&quot;currentCookies&quot;]; //è¿™é‡Œselfè¦éµå¾ªå WKScriptMessageHandler
</code></pre>
<p>åˆ™å½“æˆ‘åœ¨jsä¸­è°ƒç”¨ä¸‹é¢çš„æ–¹æ³•æ—¶</p>
<pre><code class="javascript">window.webkit.messageHandlers.currentCookies.postMessage(document.cookie);
</code></pre>
<p>æˆ‘åœ¨OCä¸­å°†ä¼šæ”¶åˆ°<code>WKScriptMessageHandler</code>çš„å›è°ƒ</p>
<pre><code class="objective-c">- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message {
    if ([message.name isEqualToString:@&quot;currentCookies&quot;]) {
        NSString *cookiesStr = message.body;    //message.bodyè¿”å›çš„æ˜¯ä¸€ä¸ªidç±»å‹çš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥æ”¯æŒå¾ˆå¤šç§jsçš„å‚æ•°ç±»å‹(jsçš„functioné™¤å¤–)
        NSLog(@&quot;å½“å‰çš„cookieä¸ºï¼š %@&quot;, cookiesStr);
    }
}
</code></pre>
<p>å½“ç„¶ï¼Œè®°å¾—åœ¨é€‚å½“çš„åœ°æ–¹è°ƒç”¨removeScriptMessageHandler</p>
<pre><code class="objective-c">- (void)dealloc {
    //è®°å¾—ç§»é™¤
    [self.webView.configuration.userContentController removeScriptMessageHandlerForName:@&quot;currentCookies&quot;];
}
</code></pre>
<p>è¿™æ ·å°±å®Œæˆäº†ä¸€æ¬¡å®Œæ•´çš„JS -&gt; OCçš„äº¤äº’ã€‚</p>
<p><strong>é—®é¢˜</strong>ï¼š</p>
<ol>
<li>è¯¥æ–¹æ³•è¿˜æ˜¯<strong>æ²¡æœ‰åŠæ³•ç›´æ¥è·å–è¿”å›å€¼</strong>ã€‚</li>
<li>é€šè¿‡<code>window.webkit.messageHandlers.&lt;name&gt;.postMessage(&lt;messageBody&gt;)</code>ä¼ é€’çš„messageBodyä¸­ä¸èƒ½åŒ…å«jsçš„functionï¼Œ<strong>å¦‚æœåŒ…å«äº†functionï¼Œé‚£ä¹ˆ OCç«¯å°†ä¸ä¼šæ”¶åˆ°å›è°ƒ</strong>ã€‚</li>
</ol>
<p>å¯¹äºé—®é¢˜1ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨å¼‚æ­¥å›è°ƒçš„æ–¹å¼ï¼Œå°†è¿”å›å€¼è¿”å›ç»™jsã€‚å¯¹äºé—®é¢˜2ï¼Œä¸€èˆ¬jsçš„å‚æ•°ä¸­åŒ…å«functionæ˜¯ä¸ºäº†å¼‚æ­¥å›è°ƒï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥æŠŠjsçš„functionè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå†ä¼ é€’ç»™OCã€‚</p>
<h3 id="å®é™…è¿ç”¨"><a href="#å®é™…è¿ç”¨" class="headerlink" title="å®é™…è¿ç”¨"></a>å®é™…è¿ç”¨</h3><p>å…³äºä¸Šè¿°é—®é¢˜1å’Œé—®é¢˜2çš„ç»“åˆåˆ©ç”¨ï¼Œå®ç°JS -&gt; OCçš„è°ƒç”¨ï¼Œå¹¶ä¸”OC -&gt; JS å¼‚æ­¥å›è°ƒç»“æœï¼Œè¿™é‡Œè¿˜æ˜¯æ‹¿åˆ†äº«æ¥ä¸¾ä¸ªä¾‹å­ã€‚</p>
<p>æ¯”å¦‚jsç«¯å®ç°äº†å¦‚ä¸‹çš„æ–¹æ³•ï¼ˆè¿™æ®µjsçš„å°è£…å‰é¢çš„æ–‡ç« é‡Œä¹Ÿæœ‰æåŠï¼Œå°ä¼™ä¼´æœ‰é—®é¢˜å¯ä»¥çœ‹ä¸‹ä¹‹å‰çš„ï¼‰ï¼š</p>
<pre><code class="javascript">  /**
   * åˆ†äº«æ–¹æ³•ï¼Œå¹¶ä¸”ä¼šå¼‚æ­¥å›è°ƒåˆ†äº«ç»“æœ
   * @param  {å¯¹è±¡ç±»å‹} shareData ä¸€ä¸ªåˆ†äº«æ•°æ®çš„å¯¹è±¡ï¼ŒåŒ…å«title,imgUrl,linkä»¥åŠä¸€ä¸ªå›è°ƒfunction
   * @return {void}     æ— åŒæ­¥è¿”å›å€¼
   */
  function shareNew(shareData) {

    //è¿™æ˜¯è¯¥æ–¹æ³•çš„é»˜è®¤å®ç°ï¼Œä¸Šç¯‡æ–‡ç« ä¸­æœ‰æ‰€æåŠ
      var title = shareData.title;
      var imgUrl = shareData.imgUrl;
      var link = shareData.link;
      var result = shareData.result;
      //do something
      //è¿™é‡Œæ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
      setTimeout(function() {
          //2sä¹‹åï¼Œå›è°ƒtrueåˆ†äº«æˆåŠŸ
          result(true);
      }, 2000);

      //ç”¨äºWKWebViewï¼Œå› ä¸ºWKWebViewå¹¶æ²¡æœ‰åŠæ³•æŠŠjs functionä¼ é€’è¿‡å»ï¼Œå› æ­¤éœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹
      //æŠŠjs functionè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œocç«¯è°ƒç”¨æ—¶ (&lt;js function string&gt;)(true); å³å¯
      shareData.result = result.toString();
      window.webkit.messageHandlers.shareNew.postMessage(shareData);
  }

  function test() {
     //æ¸…ç©ºåˆ†äº«ç»“æœ
    shareResult.innerHTML = &quot;&quot;;

      //è°ƒç”¨æ—¶ï¼Œåº”è¯¥
      shareNew({
          title: &quot;title&quot;,
          imgUrl: &quot;http://img.dd.com/xxx.png&quot;,
          link: location.href,
          result: function(res) {
              //è¿™é‡ŒshareResult ç­‰åŒäº document.getElementById(&quot;shareResult&quot;)
              shareResult.innerHTML = res ? &quot;success&quot; : &quot;failure&quot;;
          }
      });
  }
</code></pre>
<p>åœ¨htmlé¡µé¢ä¸­æˆ‘å®šä¹‰äº†ä¸€ä¸ªaæ ‡ç­¾æ¥è§¦å‘test()å‡½æ•°</p>
<pre><code class="html">&lt;a href=&quot;javascript:void(0);&quot; onclick=&quot;test()&quot;&gt;æµ‹è¯•æ–°åˆ†äº«&lt;/a&gt;
</code></pre>
<p>åœ¨OCç«¯ï¼Œå®ç°å¦‚ä¸‹</p>
<pre><code class="objective-c">//é¦–å…ˆåˆ«å¿˜äº†ï¼Œåœ¨configurationä¸­çš„userContentControllerä¸­æ·»åŠ scriptMessageHandler
[controller addScriptMessageHandler:self name:@&quot;shareNew&quot;];    //è®°å¾—é€‚å½“æ—¶å€™removeå“¦


//ç‚¹å‡»aæ ‡ç­¾æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨ä¸‹é¢çš„æ–¹æ³•
#pragma mark - WKScriptMessageHandler 

- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message {
    if ([message.name isEqualToString:@&quot;shareNew&quot;]) {
        NSDictionary *shareData = message.body;
        NSLog(@&quot;shareNewåˆ†äº«çš„æ•°æ®ä¸ºï¼š %@&quot;, shareData);
        //æ¨¡æ‹Ÿå¼‚æ­¥å›è°ƒ
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(4 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            //è¯»å–js functionçš„å­—ç¬¦ä¸²
            NSString *jsFunctionString = shareData[@&quot;result&quot;];
            //æ‹¼æ¥è°ƒç”¨è¯¥æ–¹æ³•çš„jså­—ç¬¦ä¸²
            NSString *callbackJs = [NSString stringWithFormat:@&quot;(%@)(%d);&quot;, jsFunctionString, NO];    //åé¢çš„å‚æ•°NOä¸ºæ¨¡æ‹Ÿåˆ†äº«å¤±è´¥
            //æ‰§è¡Œå›è°ƒ
            [self.webView evaluateJavaScript:callbackJs completionHandler:^(id _Nullable result, NSError * _Nullable error) {
                if (!error) {
                    NSLog(@&quot;æ¨¡æ‹Ÿå›è°ƒï¼Œåˆ†äº«å¤±è´¥&quot;);
                }
            }];
        });
    }
}
</code></pre>
<p>é‚£ä¹ˆå½“æˆ‘ç‚¹å‡»aæ ‡ç­¾æ—¶ï¼Œhtmlé¡µé¢ä¸Šè¿‡2sï¼Œä¼šæ˜¾ç¤º<strong>success</strong>ï¼Œç„¶åå†è¿‡2sï¼Œä¼šæ˜¾ç¤º<strong>failure</strong>ã€‚<img src="http://ww2.sinaimg.cn/large/006tNc79ly1ffgcsdc7m3g309w0i776l.gif" alt="new"></p>
<p>æˆ‘ä»¬æ¥ç®€å•åˆ†æä¸€ä¸‹ï¼Œç‚¹å‡»ä¹‹åï¼Œè§¦å‘äº†<code>test()</code>å‡½æ•°ï¼Œ<code>test()</code>ä¸­å°è£…äº†å¯¹<code>share()</code>å‡½æ•°çš„è°ƒç”¨ï¼Œä¸”ä¼ äº†ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¯¹è±¡ä¸­<code>result</code>å­—æ®µå¯¹åº”çš„æ˜¯ä¸ªåŒ¿åå‡½æ•°ï¼Œç´§æ¥ç€<code>share()</code>å‡½æ•°è°ƒç”¨ï¼Œå…¶ä¸­çš„å®ç°æ˜¯2sè¿‡åï¼Œ<code>result(true);</code>æ¨¡æ‹Ÿjså¼‚æ­¥å®ç°å¼‚æ­¥å›è°ƒç»“æœï¼Œåˆ†äº«æˆåŠŸã€‚åŒæ—¶<code>share()</code>å‡½æ•°ä¸­ï¼Œå› ä¸ºé€šè¿‡<code>scriptMessageHandler</code>æ— æ³•ä¼ é€’<code>function</code>ï¼Œæ‰€ä»¥å…ˆæŠŠ<code>shareData</code>å¯¹è±¡ä¸­çš„resultè¿™ä¸ªåŒ¿å<code>function</code>è½¬æˆ<code>String</code>ï¼Œç„¶åæ›¿æ¢<code>shareData</code>å¯¹è±¡çš„<code>result</code>å±æ€§ä¸ºè¿™ä¸ª<code>String</code>ï¼Œå¹¶å›ä¼ ç»™OCï¼ŒOCè¿™è¾¹å¯¹åº”JSå¯¹è±¡çš„æ•°æ®ç±»å‹æ˜¯<code>NSDictionary</code>ï¼Œæˆ‘ä»¬æ‰“å°å¹¶å¾—åˆ°äº†æ‰€æœ‰å‚æ•°ï¼ŒåŒæ—¶ï¼ŒæŠŠ<code>result</code>å­—æ®µå¯¹åº”çš„js <code>function String</code>å–å‡ºæ¥ã€‚è¿™é‡Œæˆ‘ä»¬å»¶è¿Ÿ4så›è°ƒï¼Œæ¨¡æ‹ŸNativeåˆ†äº«çš„å¼‚æ­¥è¿‡ç¨‹ï¼Œåœ¨4såï¼Œä¹Ÿå°±æ˜¯jsä¸­æ˜¾ç¤º<strong>success</strong>çš„2sè¿‡åï¼Œè°ƒç”¨jsçš„åŒ¿å<code>function</code>ï¼Œå¹¶ä¼ é€’å‚æ•°ï¼ˆåˆ†äº«ç»“æœï¼‰ã€‚è°ƒç”¨ä¸€ä¸ªjs functionçš„æ–¹æ³•æ˜¯ <code>functionName(argument);</code> ï¼Œè¿™é‡Œç”±äºè¿™ä¸ªjsçš„functionå·²ç»æ˜¯ä¸€ä¸ªStringäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è°ƒç”¨æ—¶ï¼Œéœ€è¦åŠ ä¸Š<code>()</code>ï¼Œå¦‚ <code>(functionString)(argument);</code>å› æ­¤ï¼Œæœ€ç»ˆæˆ‘ä»¬é€šè¿‡OC -&gt; JS çš„<code>evaluateJavaScript:completionHandler:</code>æ–¹æ³•ï¼ŒæˆåŠŸå®Œæˆäº†å¼‚æ­¥å›è°ƒï¼Œå¹¶ä¼ é€’ç»™jsä¸€ä¸ªåˆ†äº«å¤±è´¥çš„ç»“æœã€‚</p>
<p>ä¸Šé¢çš„æè¿°çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œå…¶å®å°±æ˜¯å…ˆæ‰§è¡Œäº†JSçš„é»˜è®¤å®ç°ï¼Œåæ‰§è¡Œäº†OCçš„å®ç°ã€‚ä¸Šé¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•è§£å†³<code>scriptMessageHandler</code>çš„ä¸¤ä¸ªé—®é¢˜ï¼Œå¹¶ä¸”å®ç°äº†ä¸€ä¸ª JS -&gt; OCã€OC -&gt; JS å®Œæ•´çš„äº¤äº’æµç¨‹ã€‚</p>
<h2 id="Cookieç®¡ç†"><a href="#Cookieç®¡ç†" class="headerlink" title="Cookieç®¡ç†"></a>Cookieç®¡ç†</h2><p>æ¯”èµ·<code>UIWebView</code>çš„è‡ªåŠ¨ç®¡ç†ï¼Œ<code>WKWebView</code>å‘çˆ¹çš„<code>Cookie</code>ç®¡ç†ï¼Œç›¸ä¿¡é˜»æ­¢äº†å¾ˆå¤šçš„å°è¯•è€…ã€‚è®¸å¤šå°ä¼™ä¼´ä¹Ÿè®¸æ›¾ç»éƒ½æƒ³ä»<code>UIWebView</code>è½¬åˆ°<code>WKWebView</code>ï¼Œä½†ä¼°è®¡å› ä¸º<code>Cookie</code>çš„é—®é¢˜ï¼Œæœ€ç»ˆéƒ½æ”¾å¼ƒäº†ï¼Œç¬”è€…æŠ˜è…¾<code>WKWebView</code>çš„<code>Cookie</code>é•¿è¾¾å¤šåŠå¹´ä¹‹ä¹…ï¼Œä¹Ÿæ›¾æƒ³æ”¾å¼ƒï¼Œä½†æœ€ç»ˆè¿˜æ˜¯åšæŒä¸‹æ¥äº†ï¼Œè™½è¯´ç°åœ¨ä¸æ•¢è¯´å®Œå…¨æŒæ¡ï¼Œè‡³å°‘ä¹Ÿä¸å½±å“æ­£å¸¸ä½¿ç”¨äº†ã€‚</p>
<p>ä¸‹é¢æ¥è¯´å‡ ç‚¹æ³¨æ„äº‹é¡¹ï¼š</p>
<ol>
<li><code>WKWebView</code>åŠ è½½ç½‘é¡µå¾—åˆ°çš„<code>Cookie</code>ä¼šåŒæ­¥åˆ°<code>NSHTTPCookieStorage</code>ä¸­ï¼ˆä¹Ÿè®¸ä½ çœ‹è¿‡ä¸€äº›æ–‡ç« è¯´ä¸èƒ½åŒæ­¥ï¼Œä½†ç¬”è€…è¿™é‡Œè¯´ä¸‹ï¼Œå®ƒçœŸçš„ä¼šï¼Œå¤§å®¶å¯ä»¥å°è¯•ä¸‹ï¼Œå®è·µå‡ºçœŸçŸ¥ï¼‰ã€‚</li>
<li><code>WKWebView</code>åŠ è½½è¯·æ±‚æ—¶ï¼Œä¸ä¼šåŒæ­¥<code>NSHTTPCookieStorage</code>ä¸­å·²æœ‰çš„<code>Cookie</code>ï¼ˆæ˜¯çš„ï¼Œ<strong>æœ€å‘çš„åœ°æ–¹</strong>ï¼‰ã€‚</li>
<li>é€šè¿‡å…±ç”¨ä¸€ä¸ª<code>WKProcessPool</code>å¹¶ä¸èƒ½è§£å†³2ä¸­<code>Cookie</code>åŒæ­¥é—®é¢˜ï¼Œä¸”å¯èƒ½ä¼šé€ æˆ<code>Cookie</code>ä¸¢å¤±ã€‚</li>
</ol>
<p>ç»“åˆè‡ªå·±çš„å®è·µå’Œå‚è€ƒä¸€äº›èµ„æ–™ï¼Œç¬”è€…å¾—åˆ°ä¸Šé¢çš„ç»“è®ºã€‚</p>
<p>å…³äºå¦‚ä½•æ“ä½œ<code>NSHTTPCookieStorage</code>ï¼Œå‰é¢çš„æ–‡ç« ä¸­æåˆ°è¿‡äº†ï¼Œæœ¬æ–‡ä¸å†èµ˜è¿°ã€‚å¯¹äºé—®é¢˜2ï¼Œ<a href="http://stackoverflow.com/questions/26573137/can-i-set-the-cookies-to-be-used-by-a-wkwebview" target="_blank" rel="external">StackOverFlowä¸Šæœ‰äº›è§£ç­”</a>ï¼Œä½†ç»è¿‡å®é™…å°è¯•ï¼Œå‘ç°è¿˜æ˜¯æˆ–å¤šæˆ–å°‘æœ‰ä¸€äº›é—®é¢˜ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªæœ€ä¸ºè‡´å‘½çš„Cookieé—®é¢˜ï¼Œéœ€è¦çš„åšçš„æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<h3 id="è§£å†³é¦–æ¬¡åŠ è½½Cookieå¸¦ä¸ä¸Šé—®é¢˜"><a href="#è§£å†³é¦–æ¬¡åŠ è½½Cookieå¸¦ä¸ä¸Šé—®é¢˜" class="headerlink" title="è§£å†³é¦–æ¬¡åŠ è½½Cookieå¸¦ä¸ä¸Šé—®é¢˜"></a>è§£å†³é¦–æ¬¡åŠ è½½Cookieå¸¦ä¸ä¸Šé—®é¢˜</h3><p>åœ¨requestçš„requestHeaderä¸­æ·»åŠ Cookieï¼š</p>
<pre><code class="objective-c">NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:[NSURL URLWithString:@&quot;http://www.baidu.com&quot;]];
NSArray *cookies = [NSHTTPCookieStorage sharedHTTPCookieStorage].cookies;
//Cookiesæ•°ç»„è½¬æ¢ä¸ºrequestHeaderFields
NSDictionary *requestHeaderFields = [NSHTTPCookie requestHeaderFieldsWithCookies:cookies];
//è®¾ç½®è¯·æ±‚å¤´
request.allHTTPHeaderFields = requestHeaderFields;
[self.webView loadRequest:request];
</code></pre>
<p>è¿™æ ·ï¼Œåªè¦ä½ <strong>ä¿è¯<code>sharedHTTPCookieStorage</code>ä¸­ä½ çš„Cookieå­˜åœ¨</strong>ï¼Œé¦–æ¬¡è®¿é—®ä¸€ä¸ªé¡µé¢ï¼Œå°±ä¸ä¼šæœ‰é—®é¢˜ã€‚</p>
<h3 id="è§£å†³åç»­Ajaxè¯·æ±‚Cookieä¸¢å¤±é—®é¢˜"><a href="#è§£å†³åç»­Ajaxè¯·æ±‚Cookieä¸¢å¤±é—®é¢˜" class="headerlink" title="è§£å†³åç»­Ajaxè¯·æ±‚Cookieä¸¢å¤±é—®é¢˜"></a>è§£å†³åç»­Ajaxè¯·æ±‚Cookieä¸¢å¤±é—®é¢˜</h3><p>è§£å†³æ­¤é—®é¢˜ï¼Œä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ·»åŠ <code>WKUserScript</code>ã€‚</p>
<pre><code class="objective-c">/*!
 *  æ›´æ–°webViewçš„cookie
 */
- (void)updateWebViewCookie
{
    WKUserScript * cookieScript = [[WKUserScript alloc] initWithSource:[self cookieString] injectionTime:WKUserScriptInjectionTimeAtDocumentStart forMainFrameOnly:NO];
    //æ·»åŠ Cookie
    [self.configuration.userContentController addUserScript:cookieScript];
}

- (NSString *)cookieString
{
    NSMutableString *script = [NSMutableString string];
    [script appendString:@&quot;var cookieNames = document.cookie.split(&#39;; &#39;).map(function(cookie) { return cookie.split(&#39;=&#39;)[0] } );\n&quot;];
    for (NSHTTPCookie *cookie in [[NSHTTPCookieStorage sharedHTTPCookieStorage] cookies]) {
        // Skip cookies that will break our script
        if ([cookie.value rangeOfString:@&quot;&#39;&quot;].location != NSNotFound) {
            continue;
        }
        // Create a line that appends this cookie to the web view&#39;s document&#39;s cookies
        [script appendFormat:@&quot;if (cookieNames.indexOf(&#39;%@&#39;) == -1) { document.cookie=&#39;%@&#39;; };\n&quot;, cookie.name, cookie.da_javascriptString];
    }
    return script;
}

@interface NSHTTPCookie (Utils)

- (NSString *)da_javascriptString;

@end

@implementation NSHTTPCookie (Utils)

- (NSString *)da_javascriptString
{
    NSString *string = [NSString stringWithFormat:@&quot;%@=%@;domain=%@;path=%@&quot;,
                        self.name,
                        self.value,
                        self.domain,
                        self.path ?: @&quot;/&quot;];
    if (self.secure) {
        string = [string stringByAppendingString:@&quot;;secure=true&quot;];
    }
    return string;
}

@end
</code></pre>
<p>åŒæ ·åªè¦ä½ <strong>ä¿è¯<code>sharedHTTPCookieStorage</code>ä¸­ä½ çš„Cookieå­˜åœ¨</strong>ï¼Œåç»­Ajaxè¯·æ±‚å°±ä¸ä¼šæœ‰é—®é¢˜ã€‚</p>
<h3 id="è§£å†³è·³è½¬æ–°é¡µé¢æ—¶Cookieå¸¦ä¸è¿‡å»é—®é¢˜"><a href="#è§£å†³è·³è½¬æ–°é¡µé¢æ—¶Cookieå¸¦ä¸è¿‡å»é—®é¢˜" class="headerlink" title="è§£å†³è·³è½¬æ–°é¡µé¢æ—¶Cookieå¸¦ä¸è¿‡å»é—®é¢˜"></a>è§£å†³è·³è½¬æ–°é¡µé¢æ—¶Cookieå¸¦ä¸è¿‡å»é—®é¢˜</h3><p>å³ä¾¿ä½ åšåˆ°äº†ä¸Šé¢ä¸¤ç‚¹ï¼Œä½ ä¼šå‘ç°ï¼Œå½“ä½ ç‚¹å‡»é¡µé¢ä¸Šçš„æŸä¸ªé“¾æ¥ï¼Œè·³è½¬åˆ°æ–°çš„é¡µé¢ï¼Œ<code>Cookie</code>åˆä¸¢äº†ğŸ˜³ï¼Œæ­¤æ—¶ä½ æ˜¯æƒ³ç‹—å¸¦çš„~æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p>
<pre><code class="objective-c">//æ ¸å¿ƒæ–¹æ³•ï¼š
/**
 ä¿®å¤æ‰“å¼€é“¾æ¥Cookieä¸¢å¤±é—®é¢˜

 @param request è¯·æ±‚
 @return ä¸€ä¸ªfixedRequest
 */
- (NSURLRequest *)fixRequest:(NSURLRequest *)request
{
    NSMutableURLRequest *fixedRequest;
    if ([request isKindOfClass:[NSMutableURLRequest class]]) {
        fixedRequest = (NSMutableURLRequest *)request;
    } else {
        fixedRequest = request.mutableCopy;
    }
    //é˜²æ­¢Cookieä¸¢å¤±
    NSDictionary *dict = [NSHTTPCookie requestHeaderFieldsWithCookies:[NSHTTPCookieStorage sharedHTTPCookieStorage].cookies];
    if (dict.count) {
        NSMutableDictionary *mDict = request.allHTTPHeaderFields.mutableCopy;
        [mDict setValuesForKeysWithDictionary:dict];
        fixedRequest.allHTTPHeaderFields = mDict;
    }
    return fixedRequest;
}

#pragma mark - WKNavigationDelegate 

- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler {

#warning important è¿™é‡Œå¾ˆé‡è¦
    //è§£å†³Cookieä¸¢å¤±é—®é¢˜
    NSURLRequest *originalRequest = navigationAction.request;
    [self fixRequest:originalRequest];
    //å¦‚æœoriginalRequestå°±æ˜¯NSMutableURLRequest, originalRequestä¸­å·²æ·»åŠ å¿…è¦çš„Cookieï¼Œå¯ä»¥è·³è½¬
    //å…è®¸è·³è½¬
    decisionHandler(WKNavigationActionPolicyAllow);
    //å¯èƒ½æœ‰å°ä¼™ä¼´ï¼Œä¼šè¯´å¦‚æœoriginalRequestæ˜¯NSURLRequestï¼Œä¸å¯å˜ï¼Œé‚£ä¸å°±æ·»åŠ ä¸äº†Cookieäº†ï¼Œæ˜¯çš„ï¼Œæˆ‘ä»¬ä¸èƒ½å› ä¸ºè¿™ä¸ªé—®é¢˜ï¼Œä¸å…è®¸è·³è½¬ï¼Œä¹Ÿä¸èƒ½åœ¨ä¸å…è®¸è·³è½¬ä¹‹åç”¨loadRequeståŠ è½½fixedRequestï¼Œå¦åˆ™ä¼šå‡ºç°æ­»å¾ªç¯ï¼Œå…·ä½“çš„ï¼Œå°ä¼™ä¼´ä»¬å¯ä»¥ç”¨æœ¬åœ°çš„htmlæµ‹è¯•ä¸‹ã€‚

    NSLog(@&quot;%@&quot;, NSStringFromSelector(_cmd));
}

#pragma mark - WKUIDelegate

- (WKWebView *)webView:(WKWebView *)webView createWebViewWithConfiguration:(WKWebViewConfiguration *)configuration forNavigationAction:(WKNavigationAction *)navigationAction windowFeatures:(WKWindowFeatures *)windowFeatures {

#warning important è¿™é‡Œä¹Ÿå¾ˆé‡è¦
    //è¿™é‡Œä¸æ‰“å¼€æ–°çª—å£
    [self.webView loadRequest:[self fixRequest:navigationAction.request]];
    return nil;
}
</code></pre>
<p>æœ€ç»ˆçš„æ–¹æ³•ï¼Œå·²ç»é™„ä¸Šã€‚å°ä¼™ä¼´ä»¬è‡ªè¡Œå‚è€ƒã€‚åŒæ ·éœ€è¦ä½ <strong>ä¿è¯<code>sharedHTTPCookieStorage</code>ä¸­ä½ çš„Cookieå­˜åœ¨</strong>ã€‚</p>
<h3 id="è§£å†³ä¸Šé¢3æ­¥éƒ½åšäº†Cookieä¾ç„¶ä¸¢å¤±"><a href="#è§£å†³ä¸Šé¢3æ­¥éƒ½åšäº†Cookieä¾ç„¶ä¸¢å¤±" class="headerlink" title="è§£å†³ä¸Šé¢3æ­¥éƒ½åšäº†Cookieä¾ç„¶ä¸¢å¤±"></a>è§£å†³ä¸Šé¢3æ­¥éƒ½åšäº†Cookieä¾ç„¶ä¸¢å¤±</h3><p>çœ‹è¿‡ä¸Šé¢çš„æ–¹æ³•è¿‡åï¼Œå°ä¼™ä¼´ä»¬åº”è¯¥è®°å¾—æœ€æ¸…æ¥šçš„æ˜¯<strong>ä¿è¯<code>sharedHTTPCookieStorage</code>ä¸­ä½ çš„Cookieå­˜åœ¨</strong>ã€‚æ€ä¹ˆä¿è¯å‘¢ï¼Ÿç”±äº<strong><code>WKWebView</code>åŠ è½½ç½‘é¡µå¾—åˆ°çš„<code>Cookie</code>ä¼šåŒæ­¥åˆ°<code>NSHTTPCookieStorage</code>ä¸­</strong>çš„ç‰¹ç‚¹ï¼Œæœ‰æ—¶å€™ä½ å¼ºè¡Œæ·»åŠ çš„<code>Cookie</code>ä¼šåœ¨åŒæ­¥è¿‡ç¨‹ä¸­ä¸¢å¤±ã€‚æŠ“åŒ…ï¼ˆ<a href="https://www.charlesproxy.com" target="_blank" rel="external">Macæ¨èCharles</a>ï¼‰ä½ å°±ä¼šå‘ç°ï¼Œç‚¹å‡»ä¸€ä¸ªé“¾æ¥æ—¶ï¼Œ<code>Request</code>çš„<code>header</code>ä¸­å¤šäº†<code>Set-Cookie</code>å­—æ®µï¼Œå…¶å®Cookieå·²ç»ä¸¢äº†ã€‚ä¸‹é¢æ¨èç¬”è€…çš„è§£å†³æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯æŠŠè‡ªå·±éœ€è¦çš„<code>Cookie</code>ä¸»åŠ¨ä¿å­˜èµ·æ¥ï¼Œæ¯æ¬¡è°ƒç”¨<code>[NSHTTPCookieStorage sharedHTTPCookieStorage].cookies</code>æ–¹æ³•æ—¶ï¼Œä¿è¯è¿”å›çš„æ•°ç»„ä¸­æœ‰è‡ªå·±éœ€è¦çš„<code>Cookie</code>ã€‚ä¸‹é¢ä¸Šä»£ç ï¼Œç”¨äº†<code>runtime</code>çš„<code>Method Swizzling</code>ï¼Œè¯¦ç»†ä»£ç ï¼Œè¯·å‚è€ƒ<a href="https://github.com/DarkAngel7/Demos-WebViewDemo" target="_blank" rel="external">Demo</a>ã€‚</p>
<p>é¦–å…ˆæ˜¯åœ¨é€‚å½“çš„æ—¶å€™ï¼Œä¿å­˜</p>
<pre><code class="objective-c">//æ¯”å¦‚ç™»å½•æˆåŠŸï¼Œä¿å­˜Cookie
NSArray *allCookies = [[NSHTTPCookieStorage sharedHTTPCookieStorage] cookies];
for (NSHTTPCookie *cookie in allCookies) {
    if ([cookie.name isEqualToString:DAServerSessionCookieName]) {
        NSDictionary *dict = [[NSUserDefaults standardUserDefaults] dictionaryForKey:DAUserDefaultsCookieStorageKey];
        if (dict) {
            NSHTTPCookie *localCookie = [NSHTTPCookie cookieWithProperties:dict];
            if (![cookie.value isEqual:localCookie.value]) {
                NSLog(@&quot;æœ¬åœ°Cookieæœ‰æ›´æ–°&quot;);
            }
        }
        [[NSUserDefaults standardUserDefaults] setObject:cookie.properties forKey:DAUserDefaultsCookieStorageKey];
        [[NSUserDefaults standardUserDefaults] synchronize];
        break;
    }
}
</code></pre>
<p>åœ¨è¯»å–æ—¶ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ·»åŠ </p>
<pre><code class="objective-c">@implementation NSHTTPCookieStorage (Utils)

+ (void)load
{
    class_methodSwizzling(self, @selector(cookies), @selector(da_cookies));
}

- (NSArray&lt;NSHTTPCookie *&gt; *)da_cookies
{
    NSArray *cookies = [self da_cookies];
    BOOL isExist = NO;
    for (NSHTTPCookie *cookie in cookies) {
        if ([cookie.name isEqualToString:DAServerSessionCookieName]) {
            isExist = YES;
            break;
        }
    }
    if (!isExist) {
        //CookieStroageä¸­æ·»åŠ 
        NSDictionary *dict = [[NSUserDefaults standardUserDefaults] dictionaryForKey:DAUserDefaultsCookieStorageKey];
        if (dict) {
            NSHTTPCookie *cookie = [NSHTTPCookie cookieWithProperties:dict];
            [[NSHTTPCookieStorage sharedHTTPCookieStorage] setCookie:cookie];
            NSMutableArray *mCookies = cookies.mutableCopy;
            [mCookies addObject:cookie];
            cookies = mCookies.copy;
        }
    }
    return cookies;
}

@end
</code></pre>
<p>å½“æ‰“å¼€æ‰‹æœºç™¾åº¦é¦–é¡µåï¼Œæˆ‘ä»¬æŸ¥çœ‹é¡µé¢ä¸­çš„Cookie<img src="http://ww4.sinaimg.cn/large/006tNc79ly1ffgge4xfiqj31jk104tj9.jpg" alt="DB6E63BA-868D-4CD2-9B1B-AC4BD1368437"></p>
<p>å…¶ä¸­ç¬¬ä¸€ä¸ªï¼Œæ˜¯ä¹‹å‰æµ‹è¯•æ·»åŠ çš„ï¼Œç”¨æ¥åŠ¨æ€æ³¨å…¥jsã€‚</p>
<pre><code class="objective-c">WKUserScript *newCookieScript = [[WKUserScript alloc] initWithSource:@&quot;document.cookie = &#39;DarkAngelCookie=DarkAngel;&#39;&quot; injectionTime:WKUserScriptInjectionTimeAtDocumentStart forMainFrameOnly:NO];
[controller addUserScript:newCookieScript];
</code></pre>
<p>ç¬¬äºŒä¸ªï¼Œå°±æ˜¯çœŸæ­£æœ‰ç”¨çš„Cookieå•¦ï¼Œè¿™å¹…å›¾ç”¨åˆ°äº†<code>Safari</code>è°ƒè¯•ï¼Œåé¢ä¼šè®²åˆ°ã€‚é€šè¿‡ä¸Šé¢çš„æŠ˜è…¾ï¼Œä¸€èˆ¬ï¼Œå°±èƒ½å¤Ÿæœ‰æ•ˆå‡å°‘Cookieçš„ä¸¢å¤±äº†ã€‚</p>
<h2 id="æ€§èƒ½å¯¹æ¯”"><a href="#æ€§èƒ½å¯¹æ¯”" class="headerlink" title="æ€§èƒ½å¯¹æ¯”"></a>æ€§èƒ½å¯¹æ¯”</h2><p>åŠ è½½ä¸€èˆ¬çš„é¡µé¢ï¼Œå¯¹æ¯”ä¸å‡ºä»€ä¹ˆï¼Œè¿™é‡Œæˆ‘å°±æµ‹è¯•ä¸‹å†…å­˜å ç”¨å§ï¼ŒåŒæ ·ä¸€ä¸ªhtmlï¼Œåˆ†å¸ƒçœ‹ä¸‹å†…å­˜å ç”¨ã€‚</p>
<p>UIWebView<img src="http://ww4.sinaimg.cn/large/006tNc79ly1ffggxn9b71j318q0gowhc.jpg" alt="C9A288B5-77EE-4FAF-8BAE-1F3E3AD7C86C"></p>
<p>WKWebView<img src="http://ww4.sinaimg.cn/large/006tNc79ly1ffggyx4o9wj31880gqgon.jpg" alt="A8AC12E1-DCDB-453A-AC24-30434485B287"></p>
<p>ä»é¡µé¢UIå…ƒç´ ä¸Šçœ‹ï¼Œ<code>WKWebView</code>è¿˜å¤šä¸ª<code>barButtonItem</code>å‘¢ï¼Œè¿™ä¹ˆç®€å•ä¸ªé¡µï¼Œå†…å­˜å ç”¨ä¹Ÿå°äº†3Mï¼Œå¤æ‚çš„é¡µé¢å¯æƒ³è€ŒçŸ¥ã€‚</p>
<h2 id="å„ç§å‘"><a href="#å„ç§å‘" class="headerlink" title="å„ç§å‘"></a>å„ç§å‘</h2><p>è™½ç„¶<code>WKWebView</code>çœŸçš„å¾ˆä¸é”™ï¼Œä½†æ˜¯å®ƒçš„å‘ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šçš„ï¼Œä¸‹é¢ç®€å•è¯´ä¸‹ã€‚</p>
<h3 id="js-alertæ–¹æ³•ä¸å¼¹çª—"><a href="#js-alertæ–¹æ³•ä¸å¼¹çª—" class="headerlink" title="js alertæ–¹æ³•ä¸å¼¹çª—"></a>js alertæ–¹æ³•ä¸å¼¹çª—</h3><p>ä¹‹å‰æè¿‡<code>WKUIDelegate</code>æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯<code>Optional</code>ï¼Œä½†å¦‚æœä½ ä¸å®ç°ï¼Œå®ƒå°±ä¼š</p>
<blockquote>
<p> If you do not implement this method, the web view will behave as if the user selected the OK button.</p>
<pre><code class="objective-c"> - (void)webView:(WKWebView *)webView runJavaScriptAlertPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(void))completionHandler;
</code></pre>
</blockquote>
<p>OKï¼Œæ„æ€å°±æ˜¯è¯´ï¼Œå¦‚æœä¸å®ç°ï¼Œå°±ä»€ä¹ˆéƒ½ä¸å‘ç”Ÿï¼Œå¥½å§ï¼Œä¹–ä¹–å®ç°å§ï¼Œå®ç°äº†å°±èƒ½å¼¹çª—äº†ã€‚</p>
<h3 id="ç™½å±é—®é¢˜"><a href="#ç™½å±é—®é¢˜" class="headerlink" title="ç™½å±é—®é¢˜"></a>ç™½å±é—®é¢˜</h3><p>å½“WKWebViewåŠ è½½çš„ç½‘é¡µå ç”¨å†…å­˜è¿‡å¤§æ—¶ï¼Œä¼šå‡ºç°ç™½å±ç°è±¡ã€‚è§£å†³æ–¹æ¡ˆæ˜¯</p>
<pre><code class="objective-c">/*! @abstract Invoked when the web view&#39;s web content process is terminated.
 @param webView The web view whose underlying web content process was terminated.
 */
- (void)webViewWebContentProcessDidTerminate:(WKWebView *)webView {
    [webView reload];    //åˆ·æ–°å°±å¥½äº†
}
</code></pre>
<p>æœ‰æ—¶ç™½å±ï¼Œä¸ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œå…·ä½“çš„è§£å†³æ–¹æ¡ˆæ˜¯</p>
<blockquote>
<p>æ¯”å¦‚ï¼Œæœ€è¿‘é‡åˆ°åœ¨ä¸€ä¸ªé«˜å†…å­˜æ¶ˆè€—çš„H5é¡µé¢ä¸Š present ç³»ç»Ÿç›¸æœºï¼Œæ‹ç…§å®Œæ¯•åè¿”å›åŸæ¥é¡µé¢çš„æ—¶å€™å‡ºç°ç™½å±ç°è±¡ï¼ˆæ‹ç…§è¿‡ç¨‹æ¶ˆè€—äº†å¤§é‡å†…å­˜ï¼Œå¯¼è‡´å†…å­˜ç´§å¼ ï¼ŒWebContent Process è¢«ç³»ç»ŸæŒ‚èµ·ï¼‰ï¼Œä½†ä¸Šé¢çš„å›è°ƒå‡½æ•°å¹¶æ²¡æœ‰è¢«è°ƒç”¨ã€‚åœ¨WKWebViewç™½å±çš„æ—¶å€™ï¼Œå¦ä¸€ç§ç°è±¡æ˜¯ webView.titile ä¼šè¢«ç½®ç©º, å› æ­¤ï¼Œå¯ä»¥åœ¨ viewWillAppear çš„æ—¶å€™æ£€æµ‹ webView.title æ˜¯å¦ä¸ºç©ºæ¥ reload é¡µé¢ã€‚ï¼ˆå‡ºè‡ª<a href="http://mp.weixin.qq.com/s/rhYKLIbXOsUJC_n6dt9UfA" target="_blank" rel="external">WKWebView é‚£äº›å‘</a>ï¼‰</p>
</blockquote>
<h3 id="Cookieä¸¢å¤±"><a href="#Cookieä¸¢å¤±" class="headerlink" title="Cookieä¸¢å¤±"></a>Cookieä¸¢å¤±</h3><p>ä»ä¸€ä¸ªç™»å½•çŠ¶æ€çš„é¡µé¢è·³è½¬åˆ°å¦ä¸€ä¸ªé¡µé¢ï¼ŒWTFï¼Œç™»å½•çŠ¶æ€ä¸¢å¤±äº†ï¼Ÿä»€ä¹ˆé¬¼ï¼Ÿå…¶å®ä¸Šæ–‡ä¸­çš„<strong>Cookieç®¡ç†</strong>ä¸€èŠ‚ï¼Œå·²ç»ä»‹ç»è¿‡è§£å†³æ–¹æ¡ˆäº†ï¼ŒåŸå› ä¹Ÿå°±æ˜¯<strong><code>WKWebView</code>åŠ è½½è¯·æ±‚æ—¶ï¼Œä¸ä¼šåŒæ­¥<code>NSHTTPCookieStorage</code>ä¸­å·²æœ‰çš„<code>Cookie</code></strong>ã€‚å¦‚æœå¶å°”è¿˜æ˜¯ä¼šå‡ºç°ä¸¢å¤±ç™»å½•çŠ¶æ€çš„æƒ…å†µï¼Œé‚£ç¬”è€…åªèƒ½è¯´ï¼Œå†æ£€æŸ¥ä¸‹è‡ªå·±çš„ä»£ç ï¼Œæ‰¾æ‰¾åŸå› ï¼Œæœ‰å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œæ¬¢è¿å‘ŠçŸ¥ç¬”è€…ã€‚</p>
<h3 id="evaluateJavaScript-completionHandler-å¼‚æ­¥"><a href="#evaluateJavaScript-completionHandler-å¼‚æ­¥" class="headerlink" title="evaluateJavaScript:completionHandler:å¼‚æ­¥"></a>evaluateJavaScript:completionHandler:å¼‚æ­¥</h3><p>è¯¥æ–¹æ³•æ˜¯å¼‚æ­¥å›è°ƒï¼Œè¿™ä¸ªä¸€çœ‹æ–¹æ³•çš„å£°æ˜ä¾¿çŸ¥ã€‚å¯èƒ½æœ‰å°ä¼™ä¼´å°±æ˜¯éœ€è¦åŒæ­¥è·å–è¿”å›å€¼ï¼Œæœ‰æ²¡æœ‰åŠæ³•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯<strong>æ²¡æœ‰</strong>ã€‚</p>
<p>å¯èƒ½ä½ ä¼šè¯´ç”¨ä¿¡å·é‡<code>dispatch_semaphore_t</code>ã€‚å¥½å§ï¼Œå¯èƒ½ä½ ä¼šè¿™ä¹ˆå†™~</p>
<pre><code class="objective-c">__block id cookies;
dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
[self.webView evaluateJavaScript:@&quot;document.cookie&quot; completionHandler:^(id _Nullable result, NSError * _Nullable error) {
    cookies = result;
    dispatch_semaphore_signal(semaphore);
}];
//ç­‰å¾…ä¸‰ç§’ï¼Œæ¥æ”¶å‚æ•°
dispatch_semaphore_wait(semaphore, dispatch_time(DISPATCH_TIME_NOW, 3 * NSEC_PER_SEC));
//æ‰“å°cookieï¼Œè‚¯å®šä¸ºç©ºï¼Œå› ä¸ºè¶³è¶³ç­‰äº†3sï¼Œdispatch_semaphore_signaléƒ½æ²¡æœ‰èµ·ä½œç”¨
NSLog(@&quot;cookieçš„å€¼ä¸ºï¼š%@&quot;, cookies);
</code></pre>
<p>ç¬”è€…æ•…æ„åªç­‰å¾…äº†3sï¼Œå¦‚æœä½ ç­‰å¾…<code>DISPATCH_TIME_FOREVER</code>ï¼Œæ­å–œä½ ï¼Œç¨‹åºä¸ä¼šCrashï¼Œä½†ç•Œé¢å¡æ­»äº†ã€‚ç¬”è€…æµ‹è¯•çš„ç»“æœæ˜¯ï¼Œ<code>NSLog</code>çš„è§¦å‘æ—¶é—´è¦æ—©äº<code>completionHandler</code>å›è°ƒï¼Œä¸è®ºä½ ç­‰å¤šä¹…ï¼Œå®ƒéƒ½ä¼šæ‰“å°nullã€‚æ‰€ä»¥å½“ä½ æ°¸ä¹…ç­‰å¾…æ—¶ï¼Œå°±å¡æ­»äº†ã€‚è¿™é‡Œçš„ç¼˜ç”±ï¼Œç¬”è€…ä¸å¤ªæ¸…æ¥šï¼Œæœ‰ææ¸…æ¥šçš„å°ä¼™ä¼´å¯ä»¥å¸®å¿™æŒ‡ç‚¹ä¸€ä¸‹ï¼Œè°¢è°¢~</p>
<p>æ‰€ä»¥è¿˜æ˜¯è€å®çš„æ¥å—å¼‚æ­¥å›è°ƒå§ï¼Œä¸è¦ç”¨ä¿¡å·æ¥ææˆåŒæ­¥ï¼Œä¼šå¡æ­»çš„ã€‚</p>
<h3 id="è‡ªå®šä¹‰contentInsetåˆ·æ–°æ—¶é¡µé¢è·³åŠ¨çš„bug"><a href="#è‡ªå®šä¹‰contentInsetåˆ·æ–°æ—¶é¡µé¢è·³åŠ¨çš„bug" class="headerlink" title="è‡ªå®šä¹‰contentInsetåˆ·æ–°æ—¶é¡µé¢è·³åŠ¨çš„bug"></a>è‡ªå®šä¹‰contentInsetåˆ·æ–°æ—¶é¡µé¢è·³åŠ¨çš„bug</h3><p>PMè¯´æ¯›ç»ç’ƒå¥½çœ‹ï¼ŒğŸ‘Œï¼Œso easyï¼Œäºæ˜¯æˆ‘ä»¬åœ¨ä»£ç å¦‚æ•²ä¸‹</p>
<pre><code class="objective-c">self.webView.scrollView.contentInset = UIEdgeInsetsMake(64, 0, 49, 0);
</code></pre>
<p>ç„¶åé»˜é»˜çš„å¾®ç¬‘ç€ç‚¹å‡»äº†cmd + Rï¼Œå¤ªç®€å•äº†ã€‚ç„¶åçœ‹åˆ°äº†è¿™æ ·çš„ç”»é¢</p>
<p><img src="http://ww1.sinaimg.cn/large/006tNc79ly1ffgi7f2g9qg30ck0n9anq.gif" alt="new"></p>
<p><img src="http://ww1.sinaimg.cn/large/006tNc79ly1ffghw4zwopj3068061wed.jpg" alt="timg"></p>
<p>æ˜¯çš„ï¼Œä¸Šé¢çš„æ–¹æ³•åœ¨<code>UIWebView</code>ä¸­æ²¡æ¯›ç—…ï¼Œå¯æ˜¯åœ¨<code>WKWebView</code>ä¸­ï¼Œå°±äº§ç”Ÿäº†åˆ·æ–°æ—¶é¡µé¢è·³åŠ¨çš„bugã€‚</p>
<p>è¿™ä¸ªå‘ï¼Œå‘äº†æˆ‘å¤§åŠå¹´ä¹‹ä¹…ï¼ŒAppleçš„<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/WebKit/ObjC_classic/index.html" target="_blank" rel="external">Document</a>ä¸­æ²¡æœ‰è®°å½•ï¼Œæœ€ç»ˆç¬”è€…åœ¨Appleå¼€æºçš„<a href="https://opensource.apple.com/source/WebKit2/" target="_blank" rel="external">WebKit2</a>çš„<a href="[https://opensource.apple.com/source/WebKit2/WebKit2-7603.1.30.0.34/ChangeLog-2014-10-07.auto.html](https://opensource.apple.com/source/WebKit2/WebKit2-7603.1.30.0.34/ChangeLog-2014-10-07.auto.html">ChangeLog</a>)ä¸­æ‰¾åˆ°äº†ç­”æ¡ˆã€‚ä¸‹é¢æ˜¯å®˜æ–¹äººå‘˜çš„å›ç­”ï¼š</p>
<p><img src="http://ww4.sinaimg.cn/large/006tNc79ly1ffghllqjz6j310w0ewagc.jpg" alt="A9018C2C-BB21-41A1-9A67-E6CCE2D75A0E"></p>
<p>å‰å®³äº†ï¼Œwordå“¥ï¼Œæˆ‘é€‰æ‹©ç‹—å¸¦ï¼Œå±…ç„¶è¿˜æ˜¯ç§æœ‰Apiã€‚æ€ä¹ˆæ•´å‘¢ï¼Ÿ</p>
<pre><code class="objective-c">self.webView.scrollView.contentInset = UIEdgeInsetsMake(64, 0, 49, 0);
//å²è¯—çº§ç¥å‘ï¼Œä¸ºä½•å¦‚æ­¤å†™å‘¢ï¼Ÿå‚è€ƒhttps://opensource.apple.com/source/WebKit2/WebKit2-7600.1.4.11.10/ChangeLog  
[self.webView setValue:[NSValue valueWithUIEdgeInsets:self.webView.scrollView.contentInset] forKey:@&quot;_obscuredInsets&quot;];    //kvcç»™WKWebViewçš„ç§æœ‰å˜é‡_obscuredInsetsè®¾ç½®å€¼
</code></pre>
<p>è¿™ä¹ˆå†™å°±OKäº†ï¼Œé€šè¿‡KVCè®¾ç½®ç§æœ‰å˜é‡çš„å€¼ï¼Œç¬”è€…ç”¨äº†åŠå¹´äº†ï¼Œè¿‡Appleå®¡æ ¸æ²¡é—®é¢˜ï¼Œä¸ç”¨æ‹…å¿ƒã€‚å¦‚æœè¿™ä¸ªèƒ½å¸®åŠ©åˆ°å¤§å®¶ï¼Œä¸ç”¨æ„Ÿè°¢æˆ‘~</p>
<h3 id="åŠ è½½POSTè¯·æ±‚ä¸¢å¤±RequestBody"><a href="#åŠ è½½POSTè¯·æ±‚ä¸¢å¤±RequestBody" class="headerlink" title="åŠ è½½POSTè¯·æ±‚ä¸¢å¤±RequestBody"></a>åŠ è½½POSTè¯·æ±‚ä¸¢å¤±RequestBody</h3><p>è¿™ä¸ªé—®é¢˜ï¼Œæ²¡æœ‰ç›´æ¥çš„è§£å†³åŠæ³•ã€‚é—®é¢˜çš„æ ¹æºåœ¨äºï¼š</p>
<blockquote>
<p>åœ¨ webkit2 çš„è®¾è®¡é‡Œä½¿ç”¨ MessageQueue è¿›è¡Œè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼ŒNetwork Process ä¼šå°†è¯·æ±‚ encode æˆä¸€ä¸ª Message,ç„¶åé€šè¿‡ IPC å‘é€ç»™ App Processã€‚å‡ºäºæ€§èƒ½çš„åŸå› ï¼Œencode çš„æ—¶å€™ HTTPBody å’Œ HTTPBodyStream è¿™ä¸¤ä¸ªå­—æ®µè¢«ä¸¢å¼ƒæ‰äº†ã€‚</p>
<p>å› æ­¤ï¼Œ<strong>å¦‚æœé€šè¿‡ registerSchemeForCustomProtocol æ³¨å†Œäº† http(s) scheme, é‚£ä¹ˆç”± WKWebView å‘èµ·çš„æ‰€æœ‰ http(s)è¯·æ±‚éƒ½ä¼šé€šè¿‡ IPC ä¼ ç»™ä¸»è¿›ç¨‹ NSURLProtocol å¤„ç†ï¼Œå¯¼è‡´ post è¯·æ±‚ body è¢«æ¸…ç©º</strong>ã€‚</p>
<p>ï¼ˆå‡ºè‡ª<a href="http://mp.weixin.qq.com/s/rhYKLIbXOsUJC_n6dt9UfA" target="_blank" rel="external">WKWebView é‚£äº›å‘</a>ï¼‰</p>
</blockquote>
<p>å‚è€ƒ <a href="https://github.com/WebKit/webkit/blob/fe39539b83d28751e86077b173abd5b7872ce3f9/Source/WebKit2/Shared/mac/WebCoreArgumentCodersMac.mm#L61-L88" target="_blank" rel="external">Appleæºç </a> åŠ <a href="https://bugs.webkit.org/show_bug.cgi?id=138169" target="_blank" rel="external">bug report</a> ã€‚</p>
<p>å…·ä½“çš„è§£å†³åŠæ³•ï¼Œå°±æ˜¯å¦è¾Ÿè¹Šå¾„ï¼Œ<a href="http://mp.weixin.qq.com/s/rhYKLIbXOsUJC_n6dt9UfA" target="_blank" rel="external">WKWebView é‚£äº›å‘</a>ä¸­æœ‰ä»‹ç»ï¼Œè¿™é‡Œç¬”è€…ä¸å†å±•å¼€ã€‚</p>
<p>å› ä¸º<code>WKWebView</code>è¢«è®¾è®¡çš„ä½¿ç”¨åœºæ™¯ï¼Œæ˜¯ç”¨æ¥å½“åšæµè§ˆå™¨ï¼Œè§£å†³Nativeå¯ä»¥ç›´æ¥åœ¨Appå†…æµè§ˆç½‘é¡µçš„é—®é¢˜ã€‚è€Œæµè§ˆå™¨æµè§ˆä¸€ä¸ªç½‘ç«™ï¼Œæ€ä¹ˆå¯èƒ½æ˜¯POSTè¯·æ±‚å‘¢ï¼Ÿæ‰€ä»¥è¿™ä¸ªé—®é¢˜ï¼Œç¬”è€…ç›®å‰æ„Ÿå—è¾ƒå°ï¼Œæœ‰éœ€è¦çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œè§£å†³ã€‚</p>
<h3 id="NSURLProtocolé—®é¢˜"><a href="#NSURLProtocolé—®é¢˜" class="headerlink" title="NSURLProtocolé—®é¢˜"></a>NSURLProtocolé—®é¢˜</h3><p><code>WKWebView</code>ä¸åŒäº<code>UIWebView</code>ï¼Œå…¶å®å¹¶ä¸æ”¯æŒ<code>NSURLProtocol</code>ã€‚å¦‚æœæƒ³æ‹¦æˆªï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ç§æœ‰Apiã€‚</p>
<pre><code class="objective-c">+ [WKBrowsingContextController registerSchemeForCustomProtocol:]
</code></pre>
<p>æ­¤æ–¹æ³•ç¼ºç‚¹ä¹Ÿå¾ˆå¤šï¼Œç¬”è€…è¿™é‡Œä¸æ¨èå°ä¼™ä¼´ä½¿ç”¨ï¼Œæ¯•ç«Ÿè°ƒç”¨ç§æœ‰Apiæ˜¯Appleç¦æ­¢çš„ã€‚å†µä¸”ï¼ŒçœŸçš„å¿…é¡»ä½¿ç”¨<code>NSURLProtocol</code>çš„è¯ï¼Œè¿˜æ˜¯ç”¨<code>UIWebView</code>å§ã€‚</p>
<h1 id="æœªå®Œå¾…ç»­"><a href="#æœªå®Œå¾…ç»­" class="headerlink" title="æœªå®Œå¾…ç»­"></a>æœªå®Œå¾…ç»­</h1><p>æœ¬æ–‡ä¸»è¦è®²è¿°äº†<code>WKWebView</code>çš„ä¸€äº›åŸºç¡€ç”¨æ³•ã€OCä¸JSçš„äº¤äº’ï¼ŒCookieçš„ç®¡ç†ï¼Œä»¥åŠä¸€äº›ä½¿ç”¨è¿‡ç¨‹ä¸­çš„å‘ï¼Œæ—¨åœ¨ä¸ºæ²¡ç”¨è¿‡çš„å°ä¼™ä¼´ä»¬è¯¦ç»†ä»‹ç»ä¸‹ã€‚è™½ç„¶å®ƒçš„å‘å¾ˆå¤šï¼Œä½†æ˜¯å®ƒçš„ä¼˜ç‚¹ä¹Ÿæœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬åº”è¯¥æ•¢äºæ‹¥æŠ±æ–°äº‹ç‰©ï¼Œæ‹¥æŠ±æ–°çŸ¥è¯†ã€‚è¿˜åœ¨ç­‰ä»€ä¹ˆï¼Ÿ<code>WKWebView</code>èµ¶å¿«ç”¨èµ·æ¥å§~</p>
<p>ä¸‹ç¯‡æ–‡ç« ï¼Œå°†ä¸»è¦ä¸ºå°ä¼™ä¼´ä»¬ä»‹ç»ä¸‹å¦‚ä½•ç”¨Safariè°ƒè¯•ï¼Œå®é™…åº”ç”¨ä¸­ä¸€äº›éœ€æ±‚å¦‚ä½•å®ç°ï¼Œå¦‚ä½•æ›´å¥½çš„ä¸å‰ç«¯h5å¼€å‘åŒå­¦é…åˆä»¥åŠå¦‚ä½•æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ç­‰ã€‚å†è§~</p>
<p>ä¸‹ç¯‡æ–‡ç« ï¼š<a href="http://blog.darkangel7.com/2017/05/11/iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸‹ï¼‰/">iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸‹ï¼‰</a></p>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Dark Angel</h4>
    <p>iOSç•Œçš„ä½è°ƒæ¢ç´¢è€…</p>
</section>
    <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone"></a><a href="#" class="bds_tsina" data-cmd="tsina"></a><a href="#" class="bds_tqq" data-cmd="tqq"></a><a href="#" class="bds_renren" data-cmd="renren"></a><a href="#" class="bds_weixin" data-cmd="weixin"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdPic":"","bdStyle":"0","bdSize":"16"},"share":{},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"åˆ†äº«åˆ°ï¼š","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/2017/05/11/iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸‹ï¼‰/">
        â† iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸‹ï¼‰
    </a>
    
    <span class="icon-logo">â€¢</span>
    
    <a class="older-posts" href="/2017/05/05/iOSä¸­NSUserDefaultsçš„é»‘ç§‘æŠ€/">
        iOSä¸­NSUserDefaultsçš„é»‘ç§‘æŠ€ â†’
    </a>
    
</nav>

  <div id="comment" class="comments-area">
    
    	<!-- å¤šè¯´è¯„è®ºæ¡† start -->
ã€€	<div class="ds-thread" data-thread-key="2017/05/10/iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸­ï¼‰/" data-title="iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸­ï¼‰" data-url="http://blog.darkangel7.com/2017/05/10/iOSä¸­UIWebViewä¸WKWebViewã€JavaScriptä¸OCäº¤äº’ã€Cookieç®¡ç†çœ‹æˆ‘å°±å¤Ÿï¼ˆä¸­ï¼‰/" data-auth-key="1"</div>	
	<!-- å¤šè¯´è¯„è®ºæ¡† end -->
	<!-- å¤šè¯´å…¬å…±JSä»£ç  start (ä¸€ä¸ªç½‘é¡µåªéœ€æ’å…¥ä¸€æ¬¡) -->
	<script type="text/javascript">
		var duoshuoQuery = {short_name:"darkangel"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] 
		 	|| document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
	</script>
	<!-- å¤šè¯´å…¬å…±JSä»£ç  end -->
    
</div>

</main>


      
<footer class="site-footer">
  
  <a class="subscribe icon-feed" href="/atom.xml"><span class="tooltip">Subscribe!</span></a>
  
  <div class="inner">
     <section class="copyright">åŸåˆ›æ–‡ç« ï¼Œç‰ˆæƒå£°æ˜ï¼šç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 2.5</section>
     <section class="copyright"><a href="/">Dark Angel</a> &copy; 2016 &bull; All Rights Reserved.</section>
     <section class="poweredby">Powered By Hexo</section>
  </div>
</footer>

      <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/8.5/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>





  </div>
</div>

<nav  class="outer-nav top horizontal">

          <a class="icon-home"  href="/"><span>Home</span></a>

          <a class="icon-news"  href="/archives"><span>Archive</span></a>

          <a class="icon-wiki"  href="https://github.com/DarkAngel7"><span>Github</span></a>

          <a class="icon-Favorites"  href="/atom.xml"><span>Rss</span></a>

</nav>

</div>
</body>
</html>
